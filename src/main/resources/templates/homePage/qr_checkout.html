<!DOCTYPE html>
<html>
<head>
    <title>Thanh toán VietQR</title>
</head>
<body>
    <h2>Quét mã QR để thanh toán</h2>
    <img id="qrImg" th:src="${qrUrl}" alt="QR Code" />
    <p>Số tiền: <b th:text="${amount}"></b></p>
    <p>Nội dung chuyển khoản: <b th:text="${description}"></b></p>
    <p>Sau khi chuyển khoản, hệ thống sẽ tự động xác nhận thanh toán.</p>
    <div id="status"></div>
    <script th:inline="javascript">
        /*<![CDATA[*/
        var orderId = /*[[${orderId}]]*/ null;

        // Polling kiểm tra trạng thái đơn hàng
        setInterval(function() {
            if (orderId) {
                fetch('/api/order/status?orderId=' + orderId)
                    .then(res => {
                        if (!res.ok) {
                            // Xử lý lỗi HTTP (ví dụ: 400, 404, 500)
                            console.error('HTTP error! status: ' + res.status);
                            return res.text().then(text => { throw new Error(text); });
                        }
                        return res.json();
                    })
                    .then(data => {
                        if (data.status === 'completed') {
                            document.getElementById('status').innerHTML = '<b style="color: green;">Đã thanh toán thành công! Bạn sẽ được chuyển hướng về trang giỏ hàng.</b>';
                            // Dừng polling sau khi thành công
                            clearInterval(this);
                            // Chuyển hướng về trang giỏ hàng sau 3 giây
                            setTimeout(function() {
                                window.location.href = '/cart'; // Giả sử URL trang giỏ hàng là /cart
                            }, 3000);
                        } else if (data.status === 'failed' || data.status === 'cancelled') {
                            document.getElementById('status').innerHTML = '<b style="color: red;">Thanh toán thất bại hoặc đã hủy! Vui lòng thử lại.</b>';
                            clearInterval(this); // Dừng polling nếu thanh toán thất bại
                            setTimeout(function() {
                                window.location.href = '/cart'; // Chuyển hướng về trang giỏ hàng sau 3 giây
                            }, 3000);
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching order status:', error);
                    });
            }
        }, 3000);
        /*]]>*/
    </script>
</body>
</html>
