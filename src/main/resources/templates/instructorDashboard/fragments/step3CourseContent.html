<div class="main-content" th:fragment="step3Content">
    <div class="container-fluid py-4">
        <!-- Page Header & Step Indicator -->
        <div class="content-card sticky-step-indicator mb-4 rounded-3 border-0 shadow-sm px-4 py-3">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-2">
                <div>
                    <h1 class="h3 mb-1 fw-bold text-primary">Create New Course</h1>
                    <p class="text-muted mb-0">Fill in the details below to create your course</p>
                </div>
            </div>
            <div class="step-indicator mt-3">
                <div class="step completed" data-step="1">
                    <div class="step-circle">1</div>
                    <div class="step-label">Basic Info</div>
                </div>
                <div class="step completed" data-step="2">
                    <div class="step-circle">2</div>
                    <div class="step-label">Course Preview</div>
                </div>
                <div class="step active" data-step="3">
                    <div class="step-circle">3</div>
                    <div class="step-label">Course Content</div>
                </div>
                <div class="step" data-step="4">
                    <div class="step-circle">4</div>
                    <div class="step-label">Preview & Publish</div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-12">
                <h3 class="mb-4">Course Content</h3>
                <button type="button" class="btn btn-primary mb-3" onclick="toggleChapterForm()">
                    <i class="bi bi-plus me-1"></i> Add Chapter
                </button>
                <form th:action="@{/instructor/createcourse/autofillchapter}" method="post" id="autoFillChapterForm">
                    <button type="button" class="btn btn-primary mb-3" onclick="confirmAutoFillChapter()">
                        <i class="bi bi-arrow-repeat me-1"></i> Fill Order Number Of Chapter
                    </button>
                </form>
                <script>
                    function confirmAutoFillChapter() {
                        if (confirm('This will automatically reorder all chapters. Are you sure you want to continue?')) {
                            document.getElementById('autoFillChapterForm').submit();
                        }
                    }
                </script>
                <!-- Toast Container -->
                <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1056">
                    <div th:if="${successMessage}" class="toast align-items-center text-white bg-success border-0 show" role="alert">
                        <div class="d-flex">
                            <div class="toast-body">
                                <span th:text="${successMessage}"></span>
                            </div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                        </div>
                    </div>
                    <div th:if="${errorMessage}" class="toast align-items-center text-white bg-danger border-0 show" role="alert">
                        <div class="d-flex">
                            <div class="toast-body">
                                <span th:text="${errorMessage}"></span>
                            </div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                        </div>
                    </div>
                </div>

                <!-- Add Chapter Form -->
                <form th:action="@{/instructor/createcourse/chaptersadd}" th:object="${chapter}" method="post" class="mb-4">
                    <div id="addChapterSection" th:class="${showForm} ? '' : 'd-none'">
                        <div class="row">
                            <!-- Chapter Title -->
                            <div class="col-12 mb-3">
                                <label class="form-label">Chapter Title</label>
                                <input type="text" th:field="*{title}" class="form-control" id="chapterTitle" placeholder="Enter the chapter title here">
                                <div style="color: red" th:if="${#fields.hasErrors('title')}" th:errors="*{title}"></div>
                            </div>

                            <!-- Chapter Description -->
                            <div class="col-12 mb-3">
                                <label class="form-label">Chapter Description</label>
                                <textarea class="form-control" th:field="*{description}" id="chapterDesc" rows="2" placeholder="Write a short description of the chapter"></textarea>
                                <div style="color: red" th:if="${#fields.hasErrors('description')}" th:errors="*{description}"></div>
                            </div>

                            <!-- Chapter Order -->
                            <div class="col-12 mb-3">
                                <label class="form-label">
                                    Chapter Order <strong><em>(If you leave this field empty, the system will automatically generate the chapter order for you.)</em></strong>
                                </label>
                                <input type="number" th:field="*{orderNumberChapter}" class="form-control" id="chapterOrder" min="1" placeholder="Enter the chapter order (e.g., 1, 2, 3...)">
                                <div style="color: red" th:if="${#fields.hasErrors('orderNumberChapter')}" th:errors="*{orderNumberChapter}"></div>
                            </div>
                        </div>

                        <!-- Save button -->
                        <button type="submit" class="btn btn-success btn-sm mt-3">
                            Save
                        </button>
                        <button type="button" class="btn btn-secondary btn-sm mt-3" onclick="toggleChapterForm()">Cancel</button>
                    </div>
                </form>
                <!-- Chapters List -->
                <div id="chaptersSection" class="accordion">
                    <div class="chapter-card mb-3" th:each="chapter, iter : ${chapters}" th:id="'chapter' + ${chapter.chapterId}">
                        <div class="chapter-header d-flex justify-content-between align-items-center">
                            <div>
                                <a th:href="'#collapseChapter' + ${chapter.chapterId}" data-bs-toggle="collapse"
                                   th:attr="aria-controls='collapseChapter' + ${chapter.chapterId}" aria-expanded="false"
                                   style="text-decoration:none;">
                                    <h4 class="mb-1" th:text="'Chapter ' + ${chapter.orderNumber} + ': ' + ${chapter.title}"></h4>
                                </a>
                                <p class="text-muted mb-0" th:text="${chapter.description}"></p>
                            </div>
                            <div class="d-flex align-items-center gap-2 mb-3">
                                <!--                                auto fill-->
                                <form th:action="@{/instructor/createcourse/autofilllesson}" method="post" th:id="'autoFillLessonForm' + ${chapter.chapterId}">
                                    <input type="hidden" name="chapterId" th:value="${chapter.chapterId}" />
                                    <button type="button" class="btn btn-sm btn-primary" th:onclick="'confirmAutoFillLesson(' + ${chapter.chapterId} + ')'">
                                        <i class="bi bi-arrow-repeat me-1"></i> Fill Order Number Of Lesson
                                    </button>
                                </form>
                                <script>
                                    function confirmAutoFillLesson(chapterId) {
                                        if (confirm('This will automatically reorder all lessons in this chapter. Are you sure you want to continue?')) {
                                            document.getElementById('autoFillLessonForm' + chapterId).submit();
                                        }
                                    }
                                </script>
                                <!-- Add Lesson button -->
                                <button type="button"
                                        class="btn btn-sm btn-primary"
                                        th:onclick="'document.getElementById(\'lessonForm' + ${chapter.chapterId} + '\').classList.toggle(\'d-none\')'">
                                    <i class="bi bi-plus me-1"></i> Add Lesson
                                </button>
                                <!-- Update Chapter button -->
                                <button type="button"
                                        class="btn btn-sm btn-outline-warning"
                                        data-bs-toggle="modal"
                                        data-bs-target="#updateChapterModal"
                                        th:attr="data-chapter-id=${chapter.chapterId},
                                                     data-title=${chapter.title},
                                                     data-description=${chapter.description},
                                                     data-ordernumber=${chapter.orderNumber}">
                                    <i class="bi bi-pencil-square"></i> Update
                                </button>

                                <!-- Delete Chapter button -->
                                <form th:action="@{/instructor/createcourse/deletechapter}" method="post">
                                    <input type="hidden" name="chapterId" th:value="${chapter.chapterId}" />
                                    <button type="submit" class="btn btn-sm btn-outline-danger"
                                            onclick="return confirm('Are you sure you want to delete this chapter?');">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </div>

                        </div>
                        <div th:id="'collapseChapter' + ${chapter.chapterId}" class="collapse chapter-body">
                            <!-- Add Lesson Form - Initially Hidden -->
                            <form th:id="'lessonForm' + ${chapter.chapterId}" class="lesson-form mt-3 d-none"
                                  th:action="@{/instructor/createcourse/addlesson}" th:object="${lessontitle}" method="post">
                                <div class="mb-2">
                                    <input type="hidden" name="chapterId" th:value="${chapter.chapterId}" />
                                    <label class="form-label">Lesson Title</label>
                                    <input type="text" th:field="*{title}" class="form-control">
                                    <div style="color: red" th:if="${#fields.hasErrors('title')}" th:errors="*{title}"></div>
                                </div>
                                <div class="mb-2">
                                    <label class="form-label">Lesson Description</label>
                                    <textarea class="form-control" th:field="*{description}" rows="2"></textarea>
                                    <div style="color: red" th:if="${#fields.hasErrors('description')}" th:errors="*{description}"></div>
                                </div>
                                <div class="mb-2 d-flex align-items-center gap-2">
                                    <label class="form-label mb-0">Is Free</label>
                                    <div class="form-check form-switch mb-0">
                                        <input class="form-check-input" type="checkbox" th:field="*{isFree}" id="isFreeSwitch">
                                        <label class="form-check-label" for="isFreeSwitch"></label>
                                        <div style="color: red" th:if="${#fields.hasErrors('isFree')}" th:errors="*{isFree}"></div>
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <label class="form-label">Order Number</label>
                                    <input type="text" class="form-control" th:field="*{orderNumber}" name="orderNumber" min="1" placeholder="Enter lesson order (e.g. 1, 2, 3...)">
                                    <div style="color: red" th:if="${#fields.hasErrors('orderNumber')}" th:errors="*{orderNumber}"></div>
                                </div>


                                <button type="submit" class="btn btn-success btn-sm">Save Lesson</button>
                                <button type="button" class="btn btn-secondary btn-sm" onclick="this.closest('form').classList.add('d-none')">Cancel</button>
                            </form>
                            <!-- Lessons List -->
                            <div th:id="'lessonsList' + ${chapter.chapterId}" th:if="${chapter.lessons != null}">
                                <!-- Quiz Form - Initially Hidden -->
                                <!-- Lesson 1 -->
                                <div class="lesson-item mb-3" th:each="lesson : ${chapter.lessons}"
                                     th:attr="data-videoid=${lesson.video != null ? lesson.video.videoUrl : null},
                                              data-quizid=${lesson.quiz != null ? lesson.quiz.id : null}"
                                     style="cursor:pointer;">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div>
                                            <h6 class="mb-1">
                                                <a href="javascript:void(0)"
                                                   class="lesson-title-link"
                                                   th:if="${lesson.video != null and lesson.video.videoUrl != null}"
                                                   th:attr="data-videoid=${lesson.video.videoUrl}"
                                                   onclick="handleLessonClick(event, this)">
                                                    <span th:text="'Lesson ' + ${lesson.orderNumber} + ': '"></span>
                                                </a>
                                                <a href="javascript:void(0)"
                                                   class="lesson-title-link"
                                                   th:if="${lesson.quiz != null}"
                                                   th:attr="data-quizid=${lesson.quiz.id}"
                                                   onclick="handleLessonClick(event, this)">
                                                    <span th:text="'Lesson ' + ${lesson.orderNumber} + ': '"></span>
                                                </a>
                                                <span th:utext="${lesson.title}"></span>
                                                <span th:if="${lesson.isFree}" class="badge bg-success ms-2">Free</span>
                                                <span th:if="${!lesson.isFree}" class="badge bg-danger ms-2">Premium</span>
                                            </h6>
                                            <p class="text-muted small mb-0" th:text="${lesson.description}"></p>
                                        </div>
                                        <div class="d-flex gap-2">
                                            <!-- Edit Lesson button -->
                                            <button type="button"
                                                    class="btn btn-sm btn-outline-warning"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#updateLessonModal"
                                                    th:data-lesson-id="${lesson.lessonId}"
                                                    th:data-title="${lesson.title}"
                                                    th:data-description="${lesson.description}"
                                                    th:data-order-number="${lesson.orderNumber}"
                                                    th:data-is-free="${lesson.isFree}"
                                                    th:data-content-type="${lesson.contentType}"
                                                    th:data-video-url="${lesson.video != null ? lesson.video.videoUrl : ''}"
                                                    th:data-duration="${lesson.duration}"
                                                    th:data-quiz-id="${lesson.quiz != null ? lesson.quiz.id : ''}"
                                                    th:data-quiz-title="${lesson.quiz != null ? lesson.quiz.title : ''}"
                                                    th:data-quiz-description="${lesson.quiz != null ? lesson.quiz.description : ''}"
                                                    th:data-quiz-time-limit="${lesson.quiz != null ? lesson.quiz.timeLimit : ''}"
                                                    onclick="prepareEditLesson(this)">
                                                <i class="bi bi-pencil-square"></i> Edit
                                            </button>

                                            <!-- Delete Lesson button -->
                                            <form th:action="@{/instructor/createcourse/deletelesson}" method="post" class="mb-0">
                                                <input type="hidden" name="lessonId" th:value="${lesson.lessonId}" />
                                                <button type="submit" class="btn btn-sm btn-outline-danger"
                                                        onclick="return confirm('Are you sure you want to delete this lesson?');">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </div>

                                    <!-- Lưu trữ thông tin câu hỏi quiz trong div ẩn -->
                                    <div th:if="${lesson.quiz != null && lesson.quiz.questions != null}"
                                         th:id="'quiz-questions-data-' + ${lesson.lessonId}"
                                         style="display: none;"
                                         class="quiz-questions-data">
                                        <div th:each="q, idx : ${lesson.quiz.questions}"
                                             th:attr="data-question=${q.question},
                                                          data-optionA=${q.optionA},
                                                          data-optionB=${q.optionB},
                                                          data-optionC=${q.optionC},
                                                          data-optionD=${q.optionD},
                                                          data-correctAnswer=${q.correctAnswer},
                                                          data-index=${idx.index}">
                                        </div>
                                    </div>

                                    <!-- Edit Lesson Form - Initially Hidden -->
                                    <div th:id="'editLessonForm' + ${lesson.lessonId}" class="edit-lesson-form mt-3 d-none">
                                        <!-- Form sẽ được điền bởi JavaScript -->
                                    </div>

                                    <!-- Show video if exists -->
                                    <div th:if="${lesson.video != null and lesson.video.videoUrl != null}" class="video-content">
                                        <div class="d-flex align-items-center gap-2">
                                            <i class="bi bi-play-circle-fill text-primary"></i>
                                            <a href="#" class="text-decoration-none lesson-video-link"
                                               th:attr="data-videoid=${lesson.video.videoUrl}">
                                                <span th:text="${lesson.title}"></span>
                                            </a>
                                            <span class="text-muted" th:text="'(' + ${lesson.duration} + ' min)'"></span>
                                        </div>
                                    </div>
                                    <!-- Show quiz-->
                                    <div th:if="${lesson.quiz != null}" class="quiz-content">
                                        <!-- Quiz Preview Card -->
                                        <div class="d-flex align-items-center gap-2 quiz-content" style="margin-bottom: 1rem;">
                                            <button class="btn btn-link p-0 m-0" style="font-size: 1.5rem; color: #0d6efd;"
                                                    th:attr="data-quizid=${lesson.quiz.id}"
                                                    data-bs-toggle="modal"
                                                    th:data-bs-target="'#quizModal' + ${lesson.quiz.id}">
                                                <i class="bi bi-question-circle-fill"></i>
                                            </button>
                                            <a href="#" class="text-decoration-none lesson-quiz-link"
                                               th:attr="data-quizid=${lesson.quiz.id}"
                                               data-bs-toggle="modal"
                                               th:data-bs-target="'#quizModal' + ${lesson.quiz.id}">
                                                <span th:text="${lesson.quiz.title}"></span>
                                            </a>
                                            <span class="text-muted" th:text="'(' + ${lesson.quiz.timeLimit} + ' min)'"></span>
                                        </div>

                                        <!-- Quiz Modal -->
                                        <div class="modal fade" th:id="'quizModal' + ${lesson.quiz.id}" tabindex="-1">
                                            <div class="modal-dialog modal-lg">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title" th:text="${lesson.quiz.title}"></h5>
                                                        <span class="badge bg-info ms-2">
                                                                            <i class="bi bi-clock me-1"></i>
                                                                            <span th:if="${(lesson.quiz.timeLimit ?: 0) < 60}"
                                                                                  th:text="${(lesson.quiz.timeLimit ?: 0) + 'm'}"></span>
                                                                            <span th:unless="${(lesson.quiz.timeLimit ?: 0) < 60}"
                                                                                  th:text="${((lesson.quiz.timeLimit ?: 0) / 60) + 'h' + ((lesson.quiz.timeLimit ?: 0) % 60) + 'm'}"></span>
                                                                        </span>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <p class="text-muted mb-4" th:text="${lesson.quiz.description}"></p>

                                                        <div class="questions-list">
                                                            <div th:each="question, stat : ${lesson.quiz.questions}" class="question-item mb-4">
                                                                <div class="card">
                                                                    <div class="card-body">
                                                                        <h6 class="mb-3" th:text="'Question ' + ${stat.count} + ': ' + ${question.question}"></h6>
                                                                        <div class="answers-list">
                                                                            <div class="answer-item mb-2">
                                                                                <div class="d-flex align-items-center">
                                                                                    <span class="badge bg-primary me-2">A</span>
                                                                                    <span th:text="${question.optionA}"></span>
                                                                                    <span th:if="${question.correctAnswer == 'A'}" class="badge bg-success ms-2">Correct</span>
                                                                                </div>
                                                                            </div>
                                                                            <div class="answer-item mb-2">
                                                                                <div class="d-flex align-items-center">
                                                                                    <span class="badge bg-primary me-2">B</span>
                                                                                    <span th:text="${question.optionB}"></span>
                                                                                    <span th:if="${question.correctAnswer == 'B'}" class="badge bg-success ms-2">Correct</span>
                                                                                </div>
                                                                            </div>
                                                                            <div class="answer-item mb-2">
                                                                                <div class="d-flex align-items-center">
                                                                                    <span class="badge bg-primary me-2">C</span>
                                                                                    <span th:text="${question.optionC}"></span>
                                                                                    <span th:if="${question.correctAnswer == 'C'}" class="badge bg-success ms-2">Correct</span>
                                                                                </div>
                                                                            </div>
                                                                            <div class="answer-item mb-2">
                                                                                <div class="d-flex align-items-center">
                                                                                    <span class="badge bg-primary me-2">D</span>
                                                                                    <span th:text="${question.optionD}"></span>
                                                                                    <span th:if="${question.correctAnswer == 'D'}" class="badge bg-success ms-2">Correct</span>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>


                                    <!-- Show content type selection and forms only if no video exists -->
                                    <div th:if="${lesson.video == null && lesson.quiz == null}">
                                        <div class="mb-3">
                                            <label class="form-label">Lesson Type</label>
                                            <input type="hidden" name="lessonId" th:value="${lesson.lessonId}" />
                                            <select class="form-select form-select-sm w-auto d-inline" onchange="toggleLessonType(this)">
                                                <option value="video">Video</option>
                                                <option value="quiz">Quiz</option>
                                            </select>
                                        </div>



                                        <!-- Video Form -->
                                        <div id="videoForm" class="video-form">
                                            <form th:action="@{/instructor/createcourse/addvideo}" th:object="${videoDTO}" method="post" enctype="multipart/form-data" class="video-upload-form">
                                                <input type="hidden" name="lessonId" th:value="${lesson.lessonId}" />
                                                <div class="mb-3">
                                                    <label class="form-label">Upload video</label>
                                                    <div class="input-group mb-3">
                                                        <input type="file" th:field="*{videoUrl}" class="form-control video-file-input" id="videoFile" accept="video/mp4" required>
                                                        <label class="input-group-text">.mp4</label>
                                                    </div>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Duration (minutes)</label>
                                                    <input type="number" th:field="*{duration}" class="form-control video-duration-input" id="videoDuration" readonly>
                                                    <small class="form-text text-muted">Duration will be calculated automatically when you select a video file.</small>
                                                </div>
                                                <div class="d-flex justify-content-end">
                                                    <button type="submit" class="btn btn-primary">Save Video</button>
                                                </div>
                                            </form>
                                        </div>

                                        <!-- Quiz Section - Initially Hidden -->
                                        <div class="quiz-section d-none">
                                            <form th:action="@{/instructor/createcourse/addquiz}" method="post" id="quizForm">
                                                <input type="hidden" name="lessonId" th:value="${lesson.lessonId}" />

                                                <div class="mb-3">
                                                    <label class="form-label">Quiz Title</label>
                                                    <input type="text" name="title" class="form-control" placeholder="Enter quiz title" required>
                                                </div>

                                                <div class="mb-3">
                                                    <label class="form-label">Quiz Description</label>
                                                    <textarea name="description" class="form-control" rows="2" placeholder="Enter quiz description" required></textarea>
                                                </div>

                                                <div class="mb-3">
                                                    <label class="form-label">Time Limit (minutes)</label>
                                                    <input type="number" name="timeLimit" class="form-control"  min="1" required>
                                                </div>

                                                <!-- Quiz List -->
                                                <div class="quiz-list mb-3">
                                                    <!-- Quizzes will be added here -->
                                                </div>

                                                <!-- Add Quiz Button -->
                                                <div class="d-flex justify-content-between mb-3">
                                                    <button type="button" class="btn btn-primary" onclick="addQuiz(this)">
                                                        Add Quiz
                                                    </button>
                                                    <button type="submit" class="btn btn-success">Save Quiz</button>
                                                </div>
                                                <template class="quiz-template">
                                                    <details class="quiz-block mb-3" open>
                                                        <summary class="d-flex justify-content-between align-items-center">
                                                            <div class="d-flex align-items-center">
                                                                <span class="quiz-number me-2">Question</span>
                                                                <h6 class="mb-0">New Question</h6>
                                                            </div>
                                                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest('.quiz-block').remove()">
                                                                <i class="bi bi-trash"></i>
                                                            </button>
                                                        </summary>
                                                        <div class="quiz-container mt-3">
                                                            <div class="mb-2">
                                                                <label class="form-label">Question*</label>
                                                                <input type="text" name="question" class="form-control quiz-question" required>
                                                            </div>
                                                            <div class="row">
                                                                <div class="col-md-6">
                                                                    <label class="form-label">Option A*</label>
                                                                    <input type="text" name="optionA" class="form-control" required>
                                                                </div>
                                                                <div class="col-md-6">
                                                                    <label class="form-label">Option B*</label>
                                                                    <input type="text" name="optionB" class="form-control" required>
                                                                </div>
                                                            </div>
                                                            <div class="row mt-2">
                                                                <div class="col-md-6">
                                                                    <label class="form-label">Option C*</label>
                                                                    <input type="text" name="optionC" class="form-control" required>
                                                                </div>
                                                                <div class="col-md-6">
                                                                    <label class="form-label">Option D*</label>
                                                                    <input type="text" name="optionD" class="form-control" required>
                                                                </div>
                                                            </div>
                                                            <div class="mt-2">
                                                                <label class="form-label">Correct Answer*</label>
                                                                <select name="correctAnswer" class="form-select" required>
                                                                    <option value="">Select correct answer</option>
                                                                    <option value="A">A</option>
                                                                    <option value="B">B</option>
                                                                    <option value="C">C</option>
                                                                    <option value="D">D</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                    </details>
                                                </template>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>



                <form th:action="@{/instructor/createcourse/submitcourse}" method="post">
                    <div class="content-card sticky-navigation-buttons rounded-3 border-0 shadow-sm px-4 py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <button class="btn btn-outline-secondary px-4 py-2 rounded-2 me-2" name="action" value="previousstep">
                                <i class="bi bi-arrow-left me-1"></i> Previous
                            </button>
                            <button class="btn btn-outline-secondary px-4 py-2 rounded-2 me-2" id="saveDraftBtn" name="action" value="draft">
                                <i class="bi bi-save me-1"></i> Save as Draft
                            </button>
                            <button class="btn btn-primary px-4 py-2 rounded-2 ms-auto" name="action" value="nextstep">
                                Next <i class="bi bi-arrow-right ms-1"></i>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
        <style>
            .d-none { display: none !important; }
            .chapter-card { border: 1px solid #dee2e6; border-radius: 8px; margin-bottom: 1.5rem; background: #fff; }
            .chapter-header { padding: 1rem; background: #f8f9fa; border-bottom: 1px solid #dee2e6; border-radius: 8px 8px 0 0; }
            .chapter-body { padding: 1rem; }
            .lesson-item { border: 1px solid #e5e7eb; border-radius: 6px; padding: 1rem; background: #fafafa; margin-bottom: 1rem; }
            .quiz-block { border: 1px solid #ffffff; border-radius: 6px; padding: 1rem; background: rgb(251, 247, 247); margin-bottom: 1rem; }
            .quiz-number { background: #f2f2f1; color: #000; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600; }
            details summary { cursor: pointer; }
            details summary > * { display: inline; }
            .quiz-container { border-left: 3px solid #cdcbc8; padding-left: 15px; margin-top: 10px; }

            /* Fix modal backdrop issues */
            .modal-backdrop {
                z-index: 1040 !important;
            }

            .modal {
                z-index: 1055 !important;
            }

            /* Ensure proper modal stacking */
            .modal.show {
                display: block !important;
            }

            /* Fix body scroll when modal is open */
            body.modal-open {
                overflow: hidden;
                padding-right: 0 !important;
            }

            /* Ensure backdrop is properly removed */
            .modal-backdrop.show {
                opacity: 0.5;
            }

            /* Fix toast z-index */
            .toast {
                z-index: 1056 !important;
            }

            /* Additional modal fixes */
            .modal-dialog {
                pointer-events: auto;
            }

            .modal-content {
                pointer-events: auto;
            }

            /* Ensure proper stacking context */
            .modal.show {
                display: block !important;
                background-color: rgba(0, 0, 0, 0.5);
            }

            /* Fix for multiple backdrops */
            .modal-backdrop + .modal-backdrop {
                z-index: 1039 !important;
            }

            body {
                min-height: 100vh;
                background-color: #f8f9fa;
            }

            .content-card {
                background-color: #fff;
                border-radius: 0.5rem;
                box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
                padding: 1.5rem;
                margin-bottom: 1.5rem;
            }

            .step-indicator {
                display: flex;
                justify-content: space-between;
                margin-bottom: 0;
                gap: 0.5rem;
            }

            .step {
                flex: 1;
                text-align: center;
                position: relative;
            }

            .step:not(:last-child)::after {
                content: '';
                position: absolute;
                top: 15px;
                right: -50%;
                width: 100%;
                height: 2px;
                background-color: #dee2e6;
                z-index: 1;
            }

            .step.active:not(:last-child)::after {
                background-color: #0d6efd;
            }

            .step-circle {
                width: 32px;
                height: 32px;
                border-radius: 50%;
                background-color: #dee2e6;
                color: #6c757d;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
                margin-bottom: 0.5rem;
                position: relative;
                z-index: 2;
                font-size: 1.1rem;
            }

            .step.active .step-circle {
                background-color: #0d6efd;
                color: white;
            }

            .step.completed .step-circle {
                background-color: #198754;
                color: white;
            }

            .image-upload-area {
                border: 2px dashed #dee2e6;
                border-radius: 0.5rem;
                padding: 2rem;
                text-align: center;
                cursor: pointer;
                transition: all 0.3s;
            }

            .image-upload-area:hover {
                border-color: #0d6efd;
                background-color: rgba(13, 110, 253, 0.05);
            }

            .image-upload-area.dragover {
                border-color: #0d6efd;
                background-color: rgba(13, 110, 253, 0.1);
            }

            .lesson-item {
                border: 1px solid #dee2e6;
                border-radius: 0.5rem;
                padding: 1rem;
                margin-bottom: 1rem;
                background-color: #f8f9fa;
            }

            .lesson-item.dragging {
                opacity: 0.5;
            }

            .drag-handle {
                cursor: move;
                color: #6c757d;
            }

            .video-upload-area {
                border: 2px dashed #dee2e6;
                border-radius: 0.5rem;
                padding: 1.5rem;
                text-align: center;
                cursor: pointer;
                transition: all 0.3s;
            }

            .video-upload-area:hover {
                border-color: #0d6efd;
                background-color: rgba(13, 110, 253, 0.05);
            }

            .progress-container {
                display: none;
                margin-top: 1rem;
            }

            .avatar {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                object-fit: cover;
            }

            .tab-content {
                padding-top: 1rem;
            }

            .form-floating textarea {
                min-height: 120px;
            }

            .preview-card {
                border: 1px solid #dee2e6;
                border-radius: 0.5rem;
                overflow: hidden;
            }

            .preview-image {
                width: 100%;
                height: 200px;
                object-fit: cover;
            }

            .sticky-sidebar {
                position: sticky;
                top: 20px;
            }
            .content-card.sticky-step-indicator {
                position: sticky;
                top: 0;
                z-index: 1000;
                background-color: #f0f4fa;
                margin-bottom: 1.5rem;
                padding-top: 10px;
                padding-bottom: 10px;
                border-bottom: 2px solid #b6c6e3;
                box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            }

            /* Style cho sticky navigation buttons */
            .content-card.sticky-navigation-buttons {
                position: sticky;
                bottom: 0;
                z-index: 1000;
                background-color: #f0f4fa;
                margin-top: 1.5rem;
                padding-top: 15px;
                padding-bottom: 15px;
                border-top: 2px solid #b6c6e3;
                box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
            }
            @media (max-width: 768px) {
                .card-body, .content-card.sticky-step-indicator, .content-card.sticky-navigation-buttons {
                    padding-left: 1rem !important;
                    padding-right: 1rem !important;
                }
            }
        </style>
        <script>
            // Minimal JavaScript - Only 3 simple functions

            // Show chapters section when Add Chapter button is clicked
            document.getElementById('addChapterBtn').onclick = function() {
                document.getElementById('addChapterSection').classList.add('d-none');
                document.getElementById('chaptersSection').classList.remove('d-none');
            };

            // Toggle between video and quiz sections
            function toggleLessonType(selectElement) {
                const lessonItem = selectElement.closest('.lesson-item');
                const videoForm = lessonItem.querySelector('.video-form');
                const quizSection = lessonItem.querySelector('.quiz-section');

                if (selectElement.value === 'video') {
                    videoForm.classList.remove('d-none');
                    quizSection.classList.add('d-none');
                } else {
                    videoForm.classList.add('d-none');
                    quizSection.classList.remove('d-none');
                }
            }

            // Add a new quiz using HTML template
            function addQuiz(buttonElement) {
                const quizSection = buttonElement.closest('.quiz-section');
                const quizList = quizSection.querySelector('.quiz-list');
                const quizTemplate = quizSection.querySelector('.quiz-template');

                // Clone the template
                const newQuiz = document.importNode(quizTemplate.content, true);

                // Update quiz number
                const quizCount = quizList.children.length + 1;
                newQuiz.querySelector('.quiz-number').textContent = `Quiz ${quizCount}`;

                // Add to the list
                quizList.appendChild(newQuiz);
            }

            // Add a new lesson using HTML template
            function addLesson(buttonElement) {
                const form = buttonElement.closest('form');
                const lessonTitle = form.querySelector('input').value;
                const lessonDescription = form.querySelector('textarea').value;

                if (!lessonTitle) {
                    alert('Please enter a lesson title');
                    return;
                }

                // Get the lessons list
                const lessonsList = document.getElementById('lessonsList1');

                // Clone the lesson template
                const lessonTemplate = document.getElementById('lesson-template');
                const newLesson = document.importNode(lessonTemplate.content, true);

                // Update lesson title and description
                newLesson.querySelector('h6').textContent = lessonTitle;
                newLesson.querySelector('p').textContent = lessonDescription || 'No description';

                // Add to the list
                lessonsList.appendChild(newLesson);

                // Hide the form
                form.classList.add('d-none');
            }
        </script>
        <script>
            window.addEventListener("DOMContentLoaded", function () {
                if (document.body.classList.contains("show-add-chapter")) {
                    document.getElementById("addChapterSection").classList.remove("d-none");
                }
            });
            function toggleChapterForm() {
                const section = document.getElementById("addChapterSection");
                section.classList.toggle("d-none");
            }

            function addChapter(event) {
                event.preventDefault();

                const title = document.getElementById("chapterTitle").value;
                const desc = document.getElementById("chapterDesc").value;

                if (!title || !desc) return;

                const chapterHTML = `
            <div class="chapter-card mb-3">
                <div class="chapter-header">
                    <h5>${title}</h5>
                    <p>${desc}</p>
                </div>
            </div>
        `;

                const container = document.getElementById("chaptersSection");
                container.insertAdjacentHTML('beforeend', chapterHTML);

                // Reset form and keep it open
                document.getElementById("addChapterForm").reset();
            }
            window.addEventListener('DOMContentLoaded', (event) => {
                const toastElList = [].slice.call(document.querySelectorAll('.toast'));
                toastElList.forEach(function (toastEl) {
                    const toast = new bootstrap.Toast(toastEl, { delay: 5000 });
                    toast.show();
                });
            });
            function toggleCollapse(element) {
                const targetId = element.getAttribute('href').substring(1);
                const targetElement = document.getElementById(targetId);
                if (targetElement.classList.contains('show')) {
                    targetElement.classList.remove('show');
                } else {
                    targetElement.classList.add('show');
                }
            }
        </script>
    </div>
    <!-- Video Modal -->
    <div class="modal fade" id="videoModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content bg-dark border-0 rounded-4">
                <div class="modal-header border-0 pb-0" style="background: transparent;">
                    <button type="button" class="btn-close btn-close-white ms-auto" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1);"></button>
                </div>
                <div class="modal-body p-0 d-flex justify-content-center align-items-center" style="min-height: 400px;">
                    <video id="dynamicVideo" controls style="width:100%; border-radius: 0 0 1rem 1rem; background:#000;">
                        Your browser does not support the video tag.
                    </video>
                </div>
            </div>
        </div>
    </div>
    <!-- Chapter Update Modal -->
    <div class="modal fade" id="updateChapterModal" tabindex="-1" aria-labelledby="updateChapterModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="updateChapterForm" th:action="@{/instructor/createcourse/updatechapter}" method="post">
                    <div class="modal-header">
                        <h5 class="modal-title" id="updateChapterModalLabel">Update Chapter</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="closeModalSafely('updateChapterModal')"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="chapterId" id="modalChapterId">
                        <div class="mb-3">
                            <label for="modalTitle" class="form-label">Title</label>
                            <input type="text" class="form-control" name="title" id="modalTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="modalDescription" class="form-label">Description</label>
                            <textarea class="form-control" name="description" id="modalDescription" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="modalOrderNumber" class="form-label">Order Number</label>
                            <input type="number" class="form-control" name="orderNumber" id="modalOrderNumber" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeModalSafely('updateChapterModal')">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script>
        document.getElementById('videoModal').addEventListener('hidden.bs.modal', function () {
            var video = document.getElementById('dynamicVideo');
            video.pause();
            video.currentTime = 0;
            video.src = "";
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var updateModal = document.getElementById('updateChapterModal');
            updateModal.addEventListener('show.bs.modal', function (event) {
                var button = event.relatedTarget;
                document.getElementById('modalChapterId').value = button.getAttribute('data-chapter-id');
                document.getElementById('modalTitle').value = button.getAttribute('data-title');
                document.getElementById('modalDescription').value = button.getAttribute('data-description');
                document.getElementById('modalOrderNumber').value = button.getAttribute('data-ordernumber');
            });

            // Xử lý modal update lesson (mới thêm)
            var updateLessonModal = document.getElementById('updateLessonModal');
            if (updateLessonModal) {
                updateLessonModal.addEventListener('show.bs.modal', function (event) {
                    var button = event.relatedTarget;
                    document.getElementById('lessonModalId').value = button.getAttribute('data-lesson-id');
                    document.getElementById('lessonModalTitle').value = button.getAttribute('data-title');
                    document.getElementById('lessonModalDescription').value = button.getAttribute('data-description');
                    document.getElementById('lessonModalOrderNumber').value = button.getAttribute('data-order-number');

                    // Xử lý checkbox Free Lesson
                    const isFree = button.getAttribute('data-is-free') === 'true';
                    document.getElementById('lessonModalIsFree').checked = isFree;
                });
            }

            // Fix modal backdrop issues for all modals
            const allModals = document.querySelectorAll('.modal');
            allModals.forEach(modal => {
                modal.addEventListener('hidden.bs.modal', function() {
                    // Remove any leftover backdrops
                    const backdrops = document.querySelectorAll('.modal-backdrop');
                    backdrops.forEach(backdrop => {
                        backdrop.remove();
                    });

                    // Remove modal-open class from body
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                });

                // Handle backdrop click
                modal.addEventListener('click', function(event) {
                    if (event.target === modal) {
                        const modalId = modal.id;
                        closeModalSafely(modalId);
                    }
                });
            });

            // Optional: Hiển thị message sau khi update (nếu có)
            var urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('successMessage')) {
                alert(urlParams.get('successMessage'));
            }
            if (urlParams.has('errorMessage')) {
                alert(urlParams.get('errorMessage'));
            }
        });
    </script>
    <script>
        // Hàm để thiết lập tính toán duration cho mỗi form video
        function setupVideoForms() {
            // Lấy tất cả các form video
            document.querySelectorAll('.video-form form').forEach(function(form) {
                const fileInput = form.querySelector('input[type="file"]');
                const durationInput = form.querySelector('input[name="duration"]');

                if (fileInput && durationInput) {
                    fileInput.addEventListener('change', function(event) {
                        const file = event.target.files[0];
                        if (file) {
                            const video = document.createElement('video');
                            video.preload = 'metadata';
                            video.onloadedmetadata = function() {
                                window.URL.revokeObjectURL(video.src);
                                const durationMinutes = Math.ceil(video.duration / 60);
                                durationInput.value = durationMinutes;
                                console.log("Duration set to:", durationMinutes, "for form:", form);
                            }
                            video.src = URL.createObjectURL(file);
                        }
                    });
                }
            });
        }

        // Chạy khi DOM đã tải xong
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM loaded, setting up video forms");
            setupVideoForms();

            // Thiết lập lại khi có thay đổi trong DOM (ví dụ: khi thêm lesson mới)
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.addedNodes.length) {
                        setupVideoForms();
                    }
                });
            });

            observer.observe(document.body, { childList: true, subtree: true });
        });
    </script>
    <!-- Lesson Update Modal -->
    <div class="modal fade" id="updateLessonModal" tabindex="-1" aria-labelledby="updateLessonModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="updateLessonModalLabel">Update Lesson</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="closeModalSafely('updateLessonModal')"></button>
                </div>
                <div class="modal-body">
                    <!-- Common Lesson Information -->
                    <div class="mb-3">
                        <label class="form-label">Lesson Type</label>
                        <select class="form-select" id="editLessonType" onchange="changeEditLessonType()">
                            <option value="video">Video</option>
                            <option value="quiz">Quiz</option>
                        </select>
                    </div>
                    <!-- Common Form Fields -->
                    <form id="updateLessonForm" th:action="@{/instructor/createcourse/updatelesson}" method="post" enctype="multipart/form-data">
                        <input type="hidden" name="lessonId" id="lessonModalId">
                        <input type="hidden" name="contentType" id="lessonModalContentType">
                        <input type="hidden" id="editVideoUrlHidden" value="">

                        <div class="mb-3">
                            <label for="lessonModalTitle" class="form-label">Title</label>
                            <input type="text" class="form-control" name="title" id="lessonModalTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="lessonModalDescription" class="form-label">Description</label>
                            <textarea class="form-control" name="description" id="lessonModalDescription" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="lessonModalOrderNumber" class="form-label">Order Number</label>
                            <input type="number" class="form-control" name="orderNumber" id="lessonModalOrderNumber" required>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="isFree" id="lessonModalIsFree">
                                <label class="form-check-label" for="lessonModalIsFree">
                                    Free Lesson
                                </label>
                            </div>
                        </div>

                        <!-- Video Form Section -->
                        <div id="videoEditSection" class="content-type-section d-none">
                            <hr>
                            <h5>Video Content</h5>

                            <!-- Current Video Preview -->
                            <div class="mb-3" id="currentVideoContainer">
                                <label class="form-label">Current Video</label>
                                <div class="ratio ratio-16x9" style="max-width: 400px;">
                                    <video id="currentLessonVideo" controls class="rounded">
                                        <source id="currentVideoSource" src="" type="video/mp4">
                                        Your browser does not support the video tag.
                                    </video>
                                </div>
                            </div>

                            <!-- Upload New Video -->
                            <div class="mb-3">
                                <label class="form-label">Upload New Video (Optional)</label>
                                <div class="input-group">
                                    <input type="file" class="form-control" id="editVideoFile" name="videoFile" accept="video/mp4">
                                    <label class="input-group-text">.mp4</label>
                                </div>
                                <div class="form-text">Leave empty to keep current video</div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Duration (minutes)</label>
                                <input type="number" class="form-control" name="duration" id="editVideoDuration" readonly>
                            </div>
                        </div>

                        <!-- Quiz Form Section -->
                        <div id="quizEditSection" class="content-type-section d-none">
                            <hr>
                            <h5>Quiz Content</h5>

                            <input type="hidden" name="quizId" id="editQuizId">

                            <div class="mb-3">
                                <label class="form-label">Quiz Title</label>
                                <input type="text" class="form-control" name="quizTitle" id="editQuizTitle">
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Quiz Description</label>
                                <textarea class="form-control" name="quizDescription" id="editQuizDescription" rows="2"></textarea>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Time Limit (minutes)</label>
                                <input type="number" class="form-control" name="quizTimeLimit" id="editQuizTimeLimit" min="1">
                            </div>

                            <!-- Questions Container -->
                            <div id="editQuestionsContainer">
                                <!-- Questions will be added here dynamically -->
                            </div>

                            <!-- Add Question Button -->
                            <button type="button" class="btn btn-primary mt-3" onclick="addEditQuestion()">
                                <i class="bi bi-plus-circle me-1"></i> Add Question
                            </button>
                        </div>

                        <div class="modal-footer mt-4">
                            <button type="button" class="btn btn-secondary" onclick="closeModalSafely('updateLessonModal')">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- Template for Quiz Question in Edit Mode -->
    <template id="edit-question-template">
        <div class="card mb-3 quiz-question">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Question <span class="question-number"></span></h6>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest('.quiz-question').remove()">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
            <div class="card-body">
                <input type="hidden" name="questionIds[]" class="question-id">
                <div class="mb-3">
                    <label class="form-label">Question</label>
                    <input type="text" class="form-control" name="questions[]" required>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Option A</label>
                        <input type="text" class="form-control" name="optionAs[]" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Option B</label>
                        <input type="text" class="form-control" name="optionBs[]" required>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Option C</label>
                        <input type="text" class="form-control" name="optionCs[]" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Option D</label>
                        <input type="text" class="form-control" name="optionDs[]" required>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Correct Answer</label>
                    <select class="form-select" name="correctAnswers[]" required>
                        <option value="A">Option A</option>
                        <option value="B">Option B</option>
                        <option value="C">Option C</option>
                        <option value="D">Option D</option>
                    </select>
                </div>
            </div>
        </div>
    </template>
    <script>
        // Clean up function to fix modal issues
        function cleanupModalIssues() {
            // Remove any leftover backdrops
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => backdrop.remove());

            // Remove modal-open class from body
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';

            // Hide any visible modals
            const visibleModals = document.querySelectorAll('.modal.show');
            visibleModals.forEach(modal => {
                modal.classList.remove('show');
                modal.style.display = 'none';
            });
        }

        // Run cleanup on page load
        document.addEventListener('DOMContentLoaded', function() {
            cleanupModalIssues();

            // Also run cleanup when page becomes visible (in case of tab switching)
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden) {
                    cleanupModalIssues();
                }
            });
        });

        // Hàm đóng modal an toàn
        function closeModalSafely(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                const bootstrapModal = bootstrap.Modal.getInstance(modal);
                if (bootstrapModal) {
                    bootstrapModal.hide();
                }

                // Force remove backdrop and clean up
                setTimeout(() => {
                    cleanupModalIssues();
                }, 150);
            }
        }

        // Hàm chuẩn bị form edit lesson
        function prepareEditLesson(button) {
            console.log("Edit button clicked");

            // Lấy dữ liệu từ button
            const lessonId = button.getAttribute('data-lesson-id');
            const title = button.getAttribute('data-title');
            const description = button.getAttribute('data-description');
            const orderNumber = button.getAttribute('data-order-number');
            const isFree = button.getAttribute('data-is-free') === 'true';
            const contentType = button.getAttribute('data-content-type');
            const videoUrl = button.getAttribute('data-video-url');
            const duration = button.getAttribute('data-duration');
            const quizId = button.getAttribute('data-quiz-id');
            const quizTitle = button.getAttribute('data-quiz-title');
            const quizDescription = button.getAttribute('data-quiz-description');
            const quizTimeLimit = button.getAttribute('data-quiz-time-limit');

            console.log("Lesson data:", {
                lessonId, title, description, orderNumber, isFree, contentType,
                videoUrl, duration, quizId, quizTitle, quizDescription, quizTimeLimit
            });

            // Điền dữ liệu vào form chung
            document.getElementById('lessonModalId').value = lessonId;
            document.getElementById('lessonModalTitle').value = title;
            document.getElementById('lessonModalDescription').value = description;
            document.getElementById('lessonModalOrderNumber').value = orderNumber;
            document.getElementById('lessonModalIsFree').checked = isFree;
            document.getElementById('lessonModalContentType').value = contentType || 'basic';

            const editLessonType = document.getElementById('editLessonType');
            if (contentType === 'video') {
                editLessonType.value = 'video';
                if (videoUrl) {
                    // --- Hàm lấy signed URL và set vào video preview ---
                    function refreshSignedUrl() {
                        fetch('/api/video/stream/video?publicId=' + encodeURIComponent(videoUrl))
                            .then(response => response.text())
                            .then(url => {
                                document.getElementById('currentVideoSource').src = url;
                                document.getElementById('currentLessonVideo').load();
                                document.getElementById('currentVideoContainer').classList.remove('d-none');
                            });
                    }
                    // Lấy URL lần đầu
                    refreshSignedUrl();
                    // Nếu đã có interval cũ thì clear
                    if (currentVideoRefreshInterval) clearInterval(currentVideoRefreshInterval);
                    // Đặt interval refresh mỗi 4 phút
                    currentVideoRefreshInterval = setInterval(refreshSignedUrl, 4 * 60 * 1000);
                } else {
                    document.getElementById('currentVideoContainer').classList.add('d-none');
                    if (currentVideoRefreshInterval) clearInterval(currentVideoRefreshInterval);
                }
                document.getElementById('editVideoDuration').value = duration || '';
            } else if (contentType === 'quiz') {
                editLessonType.value = 'quiz';
                document.getElementById('editQuizId').value = quizId || '';
                document.getElementById('editQuizTitle').value = quizTitle || '';
                document.getElementById('editQuizDescription').value = quizDescription || '';
                document.getElementById('editQuizTimeLimit').value = quizTimeLimit || '';
                loadQuizQuestions(lessonId);
                if (currentVideoRefreshInterval) clearInterval(currentVideoRefreshInterval);
            } else {
                editLessonType.value = 'basic';
                if (currentVideoRefreshInterval) clearInterval(currentVideoRefreshInterval);
            }
            changeEditLessonType();
            try {
                const modal = new bootstrap.Modal(document.getElementById('updateLessonModal'));
                modal.show();
            } catch (e) {
                console.error("Error showing modal:", e);
                alert("Could not open edit form. Please check console for errors.");
            }

            // Lưu videoUrl vào input ẩn để dùng lại khi chuyển type
            let videoUrlInput = document.getElementById('editVideoUrlHidden');
            if (videoUrlInput) videoUrlInput.value = videoUrl || '';
        }

        // Hàm thay đổi loại form khi chọn loại lesson khác
        function changeEditLessonType() {
            const selectedType = document.getElementById('editLessonType').value;
            document.getElementById('lessonModalContentType').value = selectedType;

            // Ẩn tất cả các section
            document.querySelectorAll('.content-type-section').forEach(section => {
                section.classList.add('d-none');
            });

            // Lấy videoUrl từ input ẩn (nếu có)
            let videoUrl = '';
            const videoUrlInput = document.getElementById('editVideoUrlHidden');
            if (videoUrlInput) {
                videoUrl = videoUrlInput.value;
            }

            if (selectedType === 'video') {
                document.getElementById('videoEditSection').classList.remove('d-none');
                // Nếu có videoUrl thì show current video, không thì ẩn
                if (videoUrl) {
                    document.getElementById('currentVideoContainer').classList.remove('d-none');
                } else {
                    document.getElementById('currentVideoContainer').classList.add('d-none');
                }
            } else if (selectedType === 'quiz') {
                document.getElementById('quizEditSection').classList.remove('d-none');
                document.getElementById('currentVideoContainer').classList.add('d-none');
            } else {
                document.getElementById('currentVideoContainer').classList.add('d-none');
            }
        }

        // Hàm tải câu hỏi quiz
        function loadQuizQuestions(lessonId) {
            // Xóa các câu hỏi cũ
            const container = document.getElementById('editQuestionsContainer');
            container.innerHTML = '';

            // Tìm dữ liệu câu hỏi từ div ẩn
            const questionsData = document.getElementById('quiz-questions-data-' + lessonId);
            if (!questionsData) {
                console.log("No quiz questions data found for lesson ID:", lessonId);
                return;
            }

            // Lấy tất cả các câu hỏi
            const questions = questionsData.querySelectorAll('div');
            questions.forEach((q, index) => {
                addEditQuestion({
                    id: q.getAttribute('data-id') || '',
                    question: q.getAttribute('data-question') || '',
                    optionA: q.getAttribute('data-optionA') || '',
                    optionB: q.getAttribute('data-optionB') || '',
                    optionC: q.getAttribute('data-optionC') || '',
                    optionD: q.getAttribute('data-optionD') || '',
                    correctAnswer: q.getAttribute('data-correctAnswer') || 'A',
                    index: index + 1
                });
            });
        }

        // Hàm thêm câu hỏi mới vào form edit
        function addEditQuestion(data = null) {
            const container = document.getElementById('editQuestionsContainer');
            const template = document.getElementById('edit-question-template');
            const questionElement = document.importNode(template.content, true);

            // Cập nhật số thứ tự
            const questionNumber = container.children.length + 1;
            questionElement.querySelector('.question-number').textContent = questionNumber;

            // Điền dữ liệu nếu có
            if (data) {
                questionElement.querySelector('.question-id').value = data.id;
                questionElement.querySelector('input[name="questions[]"]').value = data.question;
                questionElement.querySelector('input[name="optionAs[]"]').value = data.optionA;
                questionElement.querySelector('input[name="optionBs[]"]').value = data.optionB;
                questionElement.querySelector('input[name="optionCs[]"]').value = data.optionC;
                questionElement.querySelector('input[name="optionDs[]"]').value = data.optionD;

                const selectElement = questionElement.querySelector('select[name="correctAnswers[]"]');
                for (let i = 0; i < selectElement.options.length; i++) {
                    if (selectElement.options[i].value === data.correctAnswer) {
                        selectElement.selectedIndex = i;
                        break;
                    }
                }
            }

            container.appendChild(questionElement);
        }

        // Xử lý tính toán thời lượng video khi upload
        document.addEventListener('DOMContentLoaded', function() {
            const editVideoFile = document.getElementById('editVideoFile');
            const editVideoDuration = document.getElementById('editVideoDuration');

            if (editVideoFile && editVideoDuration) {
                editVideoFile.addEventListener('change', function(event) {
                    const file = event.target.files[0];
                    if (file) {
                        const video = document.createElement('video');
                        video.preload = 'metadata';
                        video.onloadedmetadata = function() {
                            window.URL.revokeObjectURL(video.src);
                            // duration tính bằng giây, chuyển sang phút, làm tròn lên
                            const durationMinutes = Math.ceil(video.duration / 60);
                            editVideoDuration.value = durationMinutes;
                        }
                        video.src = URL.createObjectURL(file);
                    }
                });
            }

            // Fix modal backdrop issues
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                modal.addEventListener('hidden.bs.modal', function() {
                    // Remove any leftover backdrops
                    const backdrops = document.querySelectorAll('.modal-backdrop');
                    backdrops.forEach(backdrop => {
                        backdrop.remove();
                    });

                    // Remove modal-open class from body
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                });
            });
        });
    </script>
    <script>
        function handleLessonClick(event, element) {
            event.stopPropagation();
            var videoId = element.getAttribute('data-videoid');
            var quizId = element.getAttribute('data-quizid');
            if (videoId) {
                // Phát video qua proxy backend
                var video = document.getElementById('dynamicVideo');
                video.src = '/api/video/stream/video/' + encodeURIComponent(videoId);
                var modal = new bootstrap.Modal(document.getElementById('videoModal'));
                modal.show();
                video.play();
            } else if (quizId) {
                // Mở modal quiz
                var modal = new bootstrap.Modal(document.getElementById('quizModal' + quizId));
                modal.show();
            }
        }
    </script>
    <script>
        // --- Thêm biến interval cho refresh signed URL ---
        let currentVideoRefreshInterval = null;

        // --- Sửa trong prepareEditLesson: ---
        function prepareEditLesson(button) {
            // ... code cũ ...
            const lessonId = button.getAttribute('data-lesson-id');
            const title = button.getAttribute('data-title');
            const description = button.getAttribute('data-description');
            const orderNumber = button.getAttribute('data-order-number');
            const isFree = button.getAttribute('data-is-free') === 'true';
            const contentType = button.getAttribute('data-content-type');
            const videoUrl = button.getAttribute('data-video-url');
            const duration = button.getAttribute('data-duration');
            const quizId = button.getAttribute('data-quiz-id');
            const quizTitle = button.getAttribute('data-quiz-title');
            const quizDescription = button.getAttribute('data-quiz-description');
            const quizTimeLimit = button.getAttribute('data-quiz-time-limit');

            // ... code cũ ...
            document.getElementById('lessonModalId').value = lessonId;
            document.getElementById('lessonModalTitle').value = title;
            document.getElementById('lessonModalDescription').value = description;
            document.getElementById('lessonModalOrderNumber').value = orderNumber;
            document.getElementById('lessonModalIsFree').checked = isFree;
            document.getElementById('lessonModalContentType').value = contentType || 'basic';

            const editLessonType = document.getElementById('editLessonType');
            if (contentType === 'video') {
                editLessonType.value = 'video';
                if (videoUrl) {
                    // --- Hàm lấy signed URL và set vào video preview ---
                    function refreshSignedUrl() {
                        fetch('/api/video/stream/video?publicId=' + encodeURIComponent(videoUrl))
                            .then(response => response.text())
                            .then(url => {
                                document.getElementById('currentVideoSource').src = url;
                                document.getElementById('currentLessonVideo').load();
                                document.getElementById('currentVideoContainer').classList.remove('d-none');
                            });
                    }
                    // Lấy URL lần đầu
                    refreshSignedUrl();
                    // Nếu đã có interval cũ thì clear
                    if (currentVideoRefreshInterval) clearInterval(currentVideoRefreshInterval);
                    // Đặt interval refresh mỗi 4 phút
                    currentVideoRefreshInterval = setInterval(refreshSignedUrl, 4 * 60 * 1000);
                } else {
                    document.getElementById('currentVideoContainer').classList.add('d-none');
                    if (currentVideoRefreshInterval) clearInterval(currentVideoRefreshInterval);
                }
                document.getElementById('editVideoDuration').value = duration || '';
            } else if (contentType === 'quiz') {
                editLessonType.value = 'quiz';
                document.getElementById('editQuizId').value = quizId || '';
                document.getElementById('editQuizTitle').value = quizTitle || '';
                document.getElementById('editQuizDescription').value = quizDescription || '';
                document.getElementById('editQuizTimeLimit').value = quizTimeLimit || '';
                loadQuizQuestions(lessonId);
                if (currentVideoRefreshInterval) clearInterval(currentVideoRefreshInterval);
            } else {
                editLessonType.value = 'basic';
                if (currentVideoRefreshInterval) clearInterval(currentVideoRefreshInterval);
            }
            changeEditLessonType();
            try {
                const modal = new bootstrap.Modal(document.getElementById('updateLessonModal'));
                modal.show();
            } catch (e) {
                console.error("Error showing modal:", e);
                alert("Could not open edit form. Please check console for errors.");
            }

            // Lưu videoUrl vào input ẩn để dùng lại khi chuyển type
            let videoUrlInput = document.getElementById('editVideoUrlHidden');
            if (videoUrlInput) videoUrlInput.value = videoUrl || '';
        }
        // --- Clear interval khi đóng modal ---
        document.addEventListener('DOMContentLoaded', function() {
            const updateLessonModal = document.getElementById('updateLessonModal');
            if (updateLessonModal) {
                updateLessonModal.addEventListener('hidden.bs.modal', function() {
                    if (currentVideoRefreshInterval) {
                        clearInterval(currentVideoRefreshInterval);
                        currentVideoRefreshInterval = null;
                    }
                });
            }
        });
    </script>
</div>