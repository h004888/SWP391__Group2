<div th:fragment="instructorRequestContent">

    <!-- Title -->
    <div class="row mb-3">
        <div class="col-12">
            <h1 class="h3 mb-2 mb-sm-0">Instructor Requests</h1>
        </div>
    </div>

    <!-- Success Alert -->
    <div th:if="${successMessage}"
         class="alert alert-success alert-dismissible fade show position-fixed top-0 end-0 m-4 shadow"
         role="alert" id="success-alert" style="z-index: 1055; min-width: 300px;">
        <strong th:text="${successMessage}">Thành công!</strong>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <!-- Error Alert -->
    <div th:if="${errorMessage}"
         class="alert alert-danger alert-dismissible fade show position-fixed top-0 end-0 m-4 shadow"
         role="alert" id="error-alert" style="z-index: 1055; min-width: 300px;">
        <strong th:text="${errorMessage}">Lỗi xảy ra!</strong>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <!-- Main card START -->
    <div class="card bg-transparent border">

        <!-- Card header START -->
        <div class="card-header bg-light border-bottom">
            <!-- Search and select START -->
            <div class="row g-3 align-items-center justify-content-between">
                <!-- Search bar -->
                <div class="col-md-8">
                    <form id="filterForm" class="rounded position-relative">
                        <input class="form-control bg-body" type="search" id="searchInput" placeholder="Search by name or subject..." aria-label="Search">
                        <button class="bg-transparent p-2 position-absolute top-50 end-0 translate-middle-y border-0 text-primary-hover text-reset" type="submit">
                            <i class="fas fa-search fs-6"></i>
                        </button>
                    </form>
                </div>
            </div>
            <!-- Search and select END -->
        </div>
        <!-- Card header END -->

        <!-- Card body START -->
        <div class="card-body">
            <!-- Status Tabs -->
            <div class="custom-tabs mt-4">
                <ul class="nav nav-tabs" id="requestTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="pending-tab" data-bs-toggle="tab"
                                data-bs-target="#pending" type="button" role="tab" data-status="PENDING">
                            Pending<span class="badge bg-light text-dark ms-2" id="pendingCount">0</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="approved-tab" data-bs-toggle="tab"
                                data-bs-target="#approved" type="button" role="tab" data-status="APPROVED">
                            Approved<span class="badge bg-light text-dark ms-2" id="approvedCount">0</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="rejected-tab" data-bs-toggle="tab"
                                data-bs-target="#rejected" type="button" role="tab" data-status="REJECTED">
                            Rejected<span class="badge bg-light text-dark ms-2" id="rejectedCount">0</span>
                        </button>
                    </li>
                </ul>

                <div class="tab-content p-0" id="requestTabsContent">

                    <!-- Pending Tab -->
                    <div class="tab-pane fade show active" id="pending" role="tabpanel">
                        <div class="table-responsive border-0">
                            <table class="table table-dark-gray align-middle p-4 mb-0 table-hover">
                                <!-- Table head -->
                                <thead>
                                    <tr>
                                        <th>Instructor name</th>
                                        <th>Requested Date</th>
                                        <th>Subject</th>
                                        <th>Status</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <!-- Table body -->
                                <tbody id="pendingTableBody">
                                    <!-- Data will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                        <!-- Pagination for Pending -->
                        <div id="pendingPagination" class="pagination-container">
                            <!-- Pagination will be loaded here -->
                        </div>
                    </div>

                    <!-- Accepted Tab -->
                    <div class="tab-pane fade" id="approved" role="tabpanel">
                        <div class="table-responsive border-0">
                            <table class="table table-dark-gray align-middle p-4 mb-0 table-hover">
                                <!-- Table head -->
                                <thead>
                                    <tr>
                                        <th>Instructor name</th>
                                        <th>Requested Date</th>
                                        <th>Subject</th>
                                        <th>Status</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <!-- Table body -->
                                <tbody id="approvedTableBody">
                                    <!-- Data will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                        <!-- Pagination for Accepted -->
                        <div id="approvedPagination" class="pagination-container">
                            <!-- Pagination will be loaded here -->
                        </div>
                    </div>

                    <!-- Rejected Tab -->
                    <div class="tab-pane fade" id="rejected" role="tabpanel">
                        <div class="table-responsive border-0">
                            <table class="table table-dark-gray align-middle p-4 mb-0 table-hover">
                                <!-- Table head -->
                                <thead>
                                    <tr>
                                        <th>Instructor name</th>
                                        <th>Requested Date</th>
                                        <th>Subject</th>
                                        <th>Status</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <!-- Table body -->
                                <tbody id="rejectedTableBody">
                                    <!-- Data will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                        <!-- Pagination for Rejected -->
                        <div id="rejectedPagination" class="pagination-container">
                            <!-- Pagination will be loaded here -->
                        </div>
                    </div>

                </div>
            </div>
        </div>
        <!-- Card body END -->
    </div>
    <!-- Main card END -->

    <div class="modal fade" id="appDetail" tabindex="-1" aria-labelledby="appDetaillabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">

                <!-- Modal header -->
                <div class="modal-header bg-dark">
                    <h5 class="modal-title text-white" id="appDetaillabel">Applicant details</h5>
                    <button type="button" class="btn btn-sm btn-light mb-0 ms-auto" data-bs-dismiss="modal" aria-label="Close"><i class="bi bi-x-lg"></i></button>
                </div>

                <!-- Modal body -->
                <div class="modal-body p-5">
                    <!-- Name -->
                    <span class="small">Applicant Name:</span>
                    <h6 class="mb-3" id="applicantName">Loading...</h6>

                    <!-- Email -->
                    <span class="small">Applicant Email id:</span>
                    <h6 class="mb-3" id="applicantEmail">Loading...</h6>

                    <!-- Phone number -->
                    <span class="small">Applicant Phone number:</span>
                    <h6 class="mb-3" id="applicantPhone">Loading...</h6>

                    <!-- Request Date -->
                    <span class="small">Request Date:</span>
                    <h6 class="mb-3" id="requestDate">Loading...</h6>

                    <!-- Status -->
                    <span class="small">Status:</span>
                    <h6 class="mb-3" id="requestStatus">Loading...</h6>

                    <!-- Note -->
                    <span class="small">Note:</span>
                    <p class="text-dark mb-2" id="requestNote">Loading...</p>

                    <!-- Hidden input for request ID -->
                    <input type="hidden" id="detailRequestId" name="requestId"/>
                </div>

                <!-- Modal footer -->
                <div class="modal-footer">
                    <!-- Action buttons - only show for pending requests -->
                    <div id="actionButtons" style="display: none;">
                        <button type="button" class="btn btn-success me-2" onclick="acceptRequest()">Accept Request</button>
                        <button type="button" class="btn btn-danger me-2" onclick="showRejectReason()">Reject Request</button>
                    </div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reject Reason Modal -->
    <div class="modal fade" id="rejectReasonModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="rejectForm" method="post">
                    <div class="modal-header">
                        <h5 class="modal-title">Reject Instructor Request</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>You are about to reject this instructor request.</p>

                        <!-- Hidden input for request ID -->
                        <input type="hidden" id="rejectRequestId" name="requestId"/>

                        <div class="mb-3">
                            <label class="form-label">Rejection Reason</label>
                            <textarea name="rejectionReason" class="form-control" rows="4" 
                                    placeholder="Explain why the request is rejected..." required></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger">Reject Request</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Approve Confirmation Modal -->
    <div class="modal fade" id="approveConfirmationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="approveForm" method="post">
                    <div class="modal-header">
                        <h5 class="modal-title">Approve Instructor Request</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>You are about to approve this instructor request.</p>
                        <p class="text-warning"><strong>Warning:</strong> The user will be granted instructor privileges and will be able to create and manage courses.</p>

                        <!-- Hidden input for request ID -->
                        <input type="hidden" id="approveRequestId" name="requestId"/>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success">Approve Request</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        setTimeout(function () {
            $('#success-alert').fadeOut('slow');
            $('#error-alert').fadeOut('slow');
        }, 3000);
    </script>

    <!-- JavaScript to handle loading request details -->
    <script th:inline="javascript">
        function loadRequestDetails(requestId) {
            // Store the request ID for later use
            document.getElementById('detailRequestId').value = requestId;
            
            fetch('/admin/mnInstructors/request/details/' + requestId)
                .then(response => response.json())
                .then(data => {
                    // Update modal content with the fetched data
                    document.getElementById('applicantName').textContent = data.user.fullName;
                    document.getElementById('applicantEmail').textContent = data.user.email;
                    document.getElementById('applicantPhone').textContent = data.user.phone || 'Not provided';
                    document.getElementById('requestDate').textContent = new Date(data.requestDate).toLocaleDateString();
                    document.getElementById('requestStatus').textContent = data.status || 'PENDING';
                    document.getElementById('requestNote').textContent = data.note || 'No note provided.';
                    
                    // Show/hide action buttons based on status
                    const actionButtons = document.getElementById('actionButtons');
                    if (data.status === null || data.status === 'PENDING') {
                        actionButtons.style.display = 'block';
                    } else {
                        actionButtons.style.display = 'none';
                    }
                })
                .catch(error => console.error('Error loading request details:', error));
        }

        function acceptRequest() {
            const requestId = document.getElementById('detailRequestId').value;
            document.getElementById('approveRequestId').value = requestId;
            document.getElementById('approveForm').action = '/admin/mnInstructors/request/accept/' + requestId;
            
            // Close the detail modal and open the approve modal
            const detailModal = bootstrap.Modal.getInstance(document.getElementById('appDetail'));
            detailModal.hide();
            
            // Open approve modal after a short delay
            setTimeout(() => {
                const approveModal = new bootstrap.Modal(document.getElementById('approveConfirmationModal'));
                approveModal.show();
            }, 300);
        }

        function showRejectReason() {
            const requestId = document.getElementById('detailRequestId').value;
            document.getElementById('rejectRequestId').value = requestId;
            document.getElementById('rejectForm').action = '/admin/mnInstructors/request/reject/' + requestId;
            
            // Close the detail modal and open the reject modal
            const detailModal = bootstrap.Modal.getInstance(document.getElementById('appDetail'));
            detailModal.hide();
            
            // Open reject modal after a short delay
            setTimeout(() => {
                const rejectModal = new bootstrap.Modal(document.getElementById('rejectReasonModal'));
                rejectModal.show();
            }, 300);
        }
    </script>

    <!-- Add JavaScript for handling tabs, search and filter -->
    <script th:inline="javascript">
        let currentStatus = 'PENDING';
        let currentPages = {
            PENDING: 0,
            APPROVED: 0,
            REJECTED: 0
        };

        function getTableBodyElement(status) {
            switch (status) {
                case 'PENDING':
                    return $('#pendingTableBody');
                case 'APPROVED':
                    return $('#approvedTableBody');
                case 'REJECTED':
                    return $('#rejectedTableBody');
                default:
                    return $('#pendingTableBody');
            }
        }

        function getPaginationElement(status) {
            switch (status) {
                case 'PENDING':
                    return $('#pendingPagination');
                case 'APPROVED':
                    return $('#approvedPagination');
                case 'REJECTED':
                    return $('#rejectedPagination');
                default:
                    return $('#pendingPagination');
            }
        }

        function filterRequests(status, page = 0, size = 5) {
            let keyword = $('#searchInput').val() ? $('#searchInput').val().trim() : '';

            let tableBody = getTableBodyElement(status);
            let paginationContainer = getPaginationElement(status);

            if (!tableBody || tableBody.length === 0) {
                console.error("Table body not found for status:", status);
                return;
            }

            // Update current page for this status
            currentPages[status] = page;

            // Show loading state
            tableBody.html('<tr><td colspan="5" class="text-center">Loading...</td></tr>');

            // Load table data and pagination simultaneously
            Promise.all([
                // Load table rows
                $.ajax({
                    url: '/admin/mnInstructors/request/filter',
                    method: 'GET',
                    data: {
                        keyword: keyword || null,
                        status: status,
                        page: page,
                        size: size
                    }
                }),
                // Load pagination
                $.ajax({
                    url: '/admin/mnInstructors/request/pagination',
                    method: 'GET',
                    data: {
                        keyword: keyword || null,
                        status: status,
                        page: page,
                        size: size
                    }
                }),
                // Load total count for badge
                $.ajax({
                    url: '/admin/mnInstructors/request/count',
                    method: 'GET',
                    data: {
                        keyword: keyword || null,
                        status: status
                    }
                })
            ]).then(function ([tableData, paginationData, countData]) {

                // Update table
                if (tableData && tableData.trim() !== '') {
                    tableBody.html(tableData);
                } else {
                    tableBody.html('<tr><td colspan="5" class="text-center">No requests found</td></tr>');
                }

                // Update pagination
                if (paginationData && paginationData.trim() !== '') {
                    paginationContainer.html(paginationData);
                } else {
                    paginationContainer.html('');
                }

                // Update count badge
                updateStatusCountBadge(status, countData);

            }).catch(function (error) {
                console.error("Error loading data for status:", status, error);
                tableBody.html('<tr><td colspan="5" class="text-center text-danger">Error loading data</td></tr>');
                paginationContainer.html('');
            });
        }

        function updateStatusCountBadge(status, totalCount) {
            const statusMap = {
                'PENDING': 'pendingCount',
                'APPROVED': 'approvedCount',
                'REJECTED': 'rejectedCount'
            };

            const badgeId = statusMap[status];
            const badgeElement = document.getElementById(badgeId);

            if (!badgeElement) {
                console.error("Badge element not found for status:", status);
                return;
            }

            // Set the total count from server response
            const count = typeof totalCount === 'number' ? totalCount : (totalCount ? parseInt(totalCount) : 0);
            badgeElement.textContent = count;
        }

        function loadRequests(status, page = 0) {
            console.log("Loading requests for status:", status, "page:", page);
            filterRequests(status, page);
        }

        $(document).ready(function() {
            // Load initial data for all tabs
            const statuses = ['PENDING', 'APPROVED', 'REJECTED'];
            statuses.forEach(status => {
                loadRequests(status, 0);
            });

            // Tab change event
            $('button[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
                const status = $(this).data('status');
                console.log("Tab changed to:", status);
                currentStatus = status;
                // Load current page for this status
                filterRequests(currentStatus, currentPages[currentStatus] || 0);
            });

            // Search input with debounce
            let searchTimer;
            $('#searchInput').on('input', function () {
                const searchValue = $(this).val();
                console.log("Search input triggered - value:", searchValue);
                clearTimeout(searchTimer);
                searchTimer = setTimeout(function () {
                    // Reset to first page when searching
                    currentPages[currentStatus] = 0;
                    filterRequests(currentStatus, 0);
                }, 500);
            });

            // Prevent form submission
            $('#filterForm').on('submit', function (e) {
                e.preventDefault();
                currentPages[currentStatus] = 0;
                filterRequests(currentStatus, 0);
            });

            // Event handler for pagination clicks
            $(document).on('click', '.pagination .page-link', function (e) {
                e.preventDefault();
                const page = parseInt($(this).data('page'));
                if (!isNaN(page) && page >= 0) {
                    console.log("Pagination clicked - page:", page, "for status:", currentStatus);
                    filterRequests(currentStatus, page);
                }
            });
        });
    </script>
</div>