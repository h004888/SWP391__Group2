<div th:fragment="contentMain">

    <!-- Title -->
    <div class="row">
        <div class="col-12 mb-3">
            <h1 class="h3 mb-2 mb-sm-0">Dashboard</h1>
            <div class="d-flex justify-content-end">
                <button class="btn btn-success" onclick="exportAllToExcel()">
                    <i class="fas fa-file-excel me-2"></i>Export All To Excel
                </button>
            </div>
        </div>
    </div>

    <!-- Error Alert for AJAX -->
    <div id="ajax-error-alert" class="alert alert-danger alert-dismissible fade show position-fixed top-0 end-0 m-4 shadow d-none"
         role="alert" style="z-index: 1055; min-width: 300px;">
        <strong id="ajax-error-message">An error occurred!</strong>
        <button type="button" class="btn-close" onclick="hideAjaxError()" aria-label="Close"></button>
    </div>

    <!-- Counter boxes START -->
    <div class="row g-4 mb-4">
        <!-- Counter item -->
        <div class="col-md-6 col-xxl-4">
            <div class="card card-body bg-warning bg-opacity-15 p-4 h-100">
                <div class="d-flex justify-content-between align-items-center">
                    <!-- Digit -->
                    <div>
                        <h2 class="mb-0 fw-bold" th:text="${completedEnrollments}">0</h2>
                        <span class="mb-0 h6 fw-light">Completed Courses</span>
                    </div>
                    <!-- Icon -->
                    <div class="icon-lg rounded-circle bg-warning text-white mb-0"><i class="fas fa-tv fa-fw"></i></div>
                </div>
            </div>
        </div>

        <!-- Counter item -->
        <div class="col-md-6 col-xxl-4">
            <div class="card card-body bg-purple bg-opacity-10 p-4 h-100">
                <div class="d-flex justify-content-between align-items-center">
                    <!-- Digit -->
                    <div>
                        <h2 class="mb-0 fw-bold" th:text="${totalStudents}">0</h2>
                        <span class="mb-0 h6 fw-light">Total Students</span>
                    </div>
                    <!-- Icon -->
                    <div class="icon-lg rounded-circle bg-purple text-white mb-0"><i class="fas fa-user-tie fa-fw"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Counter item -->
        <div class="col-md-6 col-xxl-4">
            <div class="card card-body bg-primary bg-opacity-10 p-4 h-100">
                <div class="d-flex justify-content-between align-items-center">
                    <!-- Digit -->
                    <div>
                        <h2 class="mb-0 fw-bold" th:text="${totalEnrollment}">0</h2>
                        <span class="mb-0 h6 fw-light">Total Enrollments</span>
                    </div>
                    <!-- Icon -->
                    <div class="icon-lg rounded-circle bg-primary text-white mb-0"><i
                            class="fas fa-user-graduate fa-fw"></i></div>
                </div>
            </div>
        </div>
        <!-- Counter item -->
        <!--        <div class="col-md-6 col-xxl-3">-->
        <!--            <div class="card card-body bg-success bg-opacity-10 p-4 h-100">-->
        <!--                <div class="d-flex justify-content-between align-items-center">-->
        <!--                    &lt;!&ndash; Digit &ndash;&gt;-->
        <!--                    <div>-->
        <!--                        <div class="d-flex">-->
        <!--                            <h2 class="mb-0 fw-bold" th:text="${totalWatchTime}">0</h2>-->
        <!--                            <span class="mb-0 h2 ms-1">hrs</span>-->
        <!--                        </div>-->
        <!--                        <span class="mb-0 h6 fw-light">Total Watch Time</span>-->
        <!--                    </div>-->
        <!--                    &lt;!&ndash; Icon &ndash;&gt;-->
        <!--                    <div class="icon-lg rounded-circle bg-success text-white mb-0"><i-->
        <!--                            class="bi bi-stopwatch-fill fa-fw"></i></div>-->
        <!--                </div>-->
        <!--            </div>-->
        <!--        </div>-->
    </div>
    <!-- Counter boxes END -->

    <!-- Chart and Ticket START -->
    <div class="row g-4 mb-4">

        <!-- Chart START -->
        <div class="col-xxl-8">
            <div class="card shadow h-100">

                <!-- Card header -->
                <div class="card-header">
                    <div class="d-flex flex-column gap-3">
                        <h5 class="card-title">Statistics</h5>
                        <div class="d-flex gap-2 align-items-center">
                            <div class="d-flex gap-2">
                                <input type="date" id="startDate" class="form-control" style="width: 200px;"/>
                                <input type="date" id="endDate" class="form-control" style="width: 200px;"/>
                            </div>
                            <button class="btn btn-primary" onclick="updateCharts()">View</button>
                        </div>
                    </div>
                </div>

                <!-- Card body -->
                <div class="card-body">
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title">Course Revenue</h5>
                                </div>
                                <div class="card-body">
                                    <div id="ChartPayoutOfYear"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Chart END -->

        <!-- Ticket START -->
        <div class="col-xxl-4">
            <div class="card shadow h-100">
                <!-- Card header -->
                <div class="card-header border-bottom d-flex flex-column gap-3 p-4">
                    <h5 class="card-header-title">Number of Students by Category</h5>
                    <div class="d-flex gap-2">
                        <input type="date" id="enrollmentStartDate" class="form-control w-50"
                               style="min-width: 100px;"/>
                        <input type="date" id="enrollmentEndDate" class="form-control w-50" style="min-width: 100px;"/>
                        <button class="btn btn-primary" onclick="updateEnrollmentChart()">View</button>
                    </div>
                </div>

                <!-- Card body START -->
                <div class="card-body p-4">
                    <!-- Apex chart -->
                    <div id="ChartPayoutEarning"></div>
                </div>
                <!-- Card body END -->
            </div>
        </div>
        <!-- Ticket END -->
    </div>
    <!-- Chart and Ticket END -->

    <!-- Top listed Cards START -->
    <div class="row g-4">

        <!-- Traffic sources START -->
        <div class="col-lg-6 col-xxl-8">
            <div class="card shadow h-100">

                <!-- Card header -->
                <div class="card-header border-bottom d-flex justify-content-between align-items-center p-4">
                    <h5 class="card-header-title">Course Maintenance Revenue</h5>
                    <div class="d-flex gap-2">
                        <input type="date" id="maintenanceStartDate" class="form-control" style="width: 150px;"/>
                        <input type="date" id="maintenanceEndDate" class="form-control" style="width: 150px;"/>
                        <button class="btn btn-primary" onclick="updateMaintenanceChart()">View</button>
                    </div>
                </div>

                <!-- Card body START -->
                <div class="card-body p-4">
                    <!-- Chart -->
                    <div id="ChartMaintenanceRevenue"></div>
                </div>
                <!-- Card body END -->
            </div>
        </div>
        <!-- Traffic sources END -->
        <!-- Top instructors START -->
        <div class="col-lg-6 col-xxl-4">
            <div class="card shadow h-100">

                <!-- Card header -->
                <div class="card-header border-bottom d-flex justify-content-between align-items-center p-4">
                    <h5 class="card-header-title">Top Instructors</h5>
                    <a th:href="@{/admin/mnInstructors}" class="btn btn-link p-0 mb-0">View all</a>
                </div>

                <!-- Card body START -->
                <div class="card-body p-4">

                    <!-- Instructor item START -->
                    <div th:each="instructor, instructorStat : ${topInstructors}"
                         class="d-sm-flex justify-content-between align-items-center mb-4">
                        <!-- Avatar and info -->
                        <div class="d-sm-flex align-items-center mb-1 mb-sm-0">
                            <!-- Avatar -->
                            <div class="avatar avatar-md flex-shrink-0">
                                <img class="avatar-img rounded-circle" th:src="${instructor.profilePicture}"
                                     alt="avatar">
                            </div>
                            <!-- Info -->
                            <div class="ms-0 ms-sm-2 mt-2 mt-sm-0">
                                <h6 class="mb-1" th:text="${instructor.userName}">Instructor Name</h6>
                                <ul class="list-inline mb-0 small">
                                    <li class="list-inline-item fw-light me-2 mb-1 mb-sm-0"><i
                                            class="fas fa-book text-purple me-1"></i>
                                        <span th:text="${instructor.course.size()}">0</span> Courses
                                    </li>
                                    <li class="list-inline-item fw-light me-2 mb-1 mb-sm-0"><i
                                            class="fas fa-star text-warning me-1"></i>4.5/5.0
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <!-- Button -->
                        <a th:href="@{/admin/mnInstructors/viewInfo/{userId}(userId=${instructor.userId})}" class="btn btn-sm btn-light mb-0">View</a>
                    </div>
                    <!-- Instructor item END -->

                </div>
                <!-- Card body END -->
            </div>
        </div>
        <!-- Top instructors END -->
    </div>
    <!-- Top listed Cards END -->

    <script th:inline="javascript">
        // Initialize data from controller
        window.revenuePerMonth = /*[[${revenuePerMonth}]]*/ {};
        window.enrollmentsByCategory = /*[[${enrollmentsByCategory}]]*/ {};
        window.maintenanceRevenue = /*[[${maintenanceRevenue}]]*/ {};

        function initializeCharts() {
            // Set default date range to current year
            const now = new Date();
            const firstDay = new Date(now.getFullYear(), 0, 2);//01/01/2025

            document.getElementById('startDate').value = firstDay.toISOString().split('T')[0];
            document.getElementById('endDate').value = now.toISOString().split('T')[0];
            document.getElementById('enrollmentStartDate').value = firstDay.toISOString().split('T')[0];
            document.getElementById('enrollmentEndDate').value = now.toISOString().split('T')[0];
            document.getElementById('maintenanceStartDate').value = firstDay.toISOString().split('T')[0];
            document.getElementById('maintenanceEndDate').value = now.toISOString().split('T')[0];

            // First render charts with initial data
            if (typeof e !== 'undefined') {
                e.dashboardChart();
                e.earningChart();
                e.maintenanceChart();
            }

            // Then fetch updated data
            Promise.all([
                fetch(`/admin/revenue?startDate=${firstDay.toISOString().split('T')[0]}&endDate=${now.toISOString().split('T')[0]}`).then(response => response.json()),
                fetch(`/admin/enrollments?startDate=${firstDay.toISOString().split('T')[0]}&endDate=${now.toISOString().split('T')[0]}`).then(response => response.json()),
                fetch(`/admin/maintenance-revenue?startDate=${firstDay.toISOString().split('T')[0]}&endDate=${now.toISOString().split('T')[0]}`).then(response => response.json())
            ]).then(([revenueData, enrollmentData, maintenanceData]) => {
                // Only update if we have data
                if (Object.keys(enrollmentData).length > 0) {
                    window.enrollmentsByCategory = enrollmentData;
                }
                window.revenuePerMonth = revenueData;
                window.maintenanceRevenue = maintenanceData;

                // Update charts with fetched data
                if (typeof e !== 'undefined') {
                    e.dashboardChart();
                    e.earningChart();
                    e.maintenanceChart();
                }
            }).catch(error => {
                console.error('Error loading data:', error);
            });
        }

        function showAjaxError(msg) {
            const alertDiv = document.getElementById('ajax-error-alert');
            const msgSpan = document.getElementById('ajax-error-message');
            msgSpan.textContent = msg || 'An error occurred!';
            alertDiv.classList.remove('d-none');
        }
        function hideAjaxError() {
            document.getElementById('ajax-error-alert').classList.add('d-none');
        }

        function isDateRangeValid(start, end) {
            if (!start || !end) return false;
            return new Date(start) <= new Date(end);
        }

        function updateCharts() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            if (!startDate || !endDate) {
                showAjaxError('Please select a date range');
                return;
            }
            if (!isDateRangeValid(startDate, endDate)) {
                showAjaxError('End date must be after or equal to start date');
                return;
            }
            fetch(`/admin/revenue?startDate=${startDate}&endDate=${endDate}`)
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw err; });
                    }
                    return response.json();
                })
                .then(data => {
                    window.revenuePerMonth = data;
                    if (typeof e !== 'undefined') {
                        e.dashboardChart();
                    }
                    hideAjaxError();
                })
                .catch(error => {
                    showAjaxError(error.error || 'Error updating revenue chart');
                });
        }

        function updateEnrollmentChart() {
            const startDate = document.getElementById('enrollmentStartDate').value;
            const endDate = document.getElementById('enrollmentEndDate').value;
            if (!startDate || !endDate) {
                showAjaxError('Please select a date range');
                return;
            }
            if (!isDateRangeValid(startDate, endDate)) {
                showAjaxError('End date must be after or equal to start date');
                return;
            }
            fetch(`/admin/enrollments?startDate=${startDate}&endDate=${endDate}`)
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw err; });
                    }
                    return response.json();
                })
                .then(data => {
                    window.enrollmentsByCategory = data;
                    if (typeof e !== 'undefined') {
                        e.earningChart();
                    }
                    hideAjaxError();
                })
                .catch(error => {
                    showAjaxError(error.error || 'Error updating enrollment chart');
                });
        }

        function updateMaintenanceChart() {
            const startDate = document.getElementById('maintenanceStartDate').value;
            const endDate = document.getElementById('maintenanceEndDate').value;
            if (!startDate || !endDate) {
                showAjaxError('Please select a date range');
                return;
            }
            if (!isDateRangeValid(startDate, endDate)) {
                showAjaxError('End date must be after or equal to start date');
                return;
            }
            fetch(`/admin/maintenance-revenue?startDate=${startDate}&endDate=${endDate}`)
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw err; });
                    }
                    return response.json();
                })
                .then(data => {
                    window.maintenanceRevenue = data;
                    if (typeof e !== 'undefined') {
                        e.maintenanceChart();
                    }
                    hideAjaxError();
                })
                .catch(error => {
                    showAjaxError(error.error || 'Error updating maintenance chart');
                });
        }

        function exportAllToExcel() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            if (!startDate || !endDate) {
                showAjaxError('Please select a date range');
                return;
            }
            if (!isDateRangeValid(startDate, endDate)) {
                showAjaxError('End date must be after or equal to start date');
                return;
            }
            // Create URL to download the combined Excel file
            const url = `/admin/export-excel-charts?startDate=${startDate}&endDate=${endDate}`;
            window.location.href = url;
        }

        // Initialize charts as soon as the script is loaded
        if (typeof e !== 'undefined') {
            e.dashboardChart();
            e.earningChart();
            e.maintenanceChart();
        }

        // Ràng buộc endDate không được nhỏ hơn startDate
        function bindDateRange(startId, endId) {
            const startInput = document.getElementById(startId);
            const endInput = document.getElementById(endId);
            if (!startInput || !endInput) return;
            startInput.addEventListener('change', function () {
                endInput.min = startInput.value;
                // Nếu endDate hiện tại < startDate thì reset endDate
                if (endInput.value && endInput.value < startInput.value) {
                    endInput.value = startInput.value;
                }
            });
        }
        document.addEventListener('DOMContentLoaded', function () {
            initializeCharts();
            // Áp dụng cho tất cả các cặp date filter
            bindDateRange('startDate', 'endDate');
            bindDateRange('enrollmentStartDate', 'enrollmentEndDate');
            bindDateRange('maintenanceStartDate', 'maintenanceEndDate');
        });

        setTimeout(function () {
            if (document.readyState === 'complete') {
                initializeCharts();
            }
        }, 100);
    </script>

</div>