<div id="courseContentContainer" class="container-fluid" th:fragment="courseContent">
    <div class="table-responsive">
        <div class="table-wrapper">
            <div class="table-title">
                <form id="filterForm" method="get">
                    <div class="row">
                        <div class="col-md-8">
                            <h2 th:text="${accNamePage}">Management <b>Course</b></h2>
                        </div>

                        <div class="col-md-4">
                            <div class="search-box">
                                <i class="material-icons">&#xE8B6;</i>
                                <input id="searchInput" type="text" name="keyword" class="form-control"
                                       placeholder="Search&hellip;"
                                       th:value="${keyword}">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 d-flex gap-2 mt-4">
                        <select class="form-control ml-2" name="category" id="filterCategory">
                            <option value="">All Categories</option>
                            <option th:each="cate : ${listCategories}"
                                    th:value="${cate.id}"
                                    th:text="${cate.name}"
                                    th:selected="${cate.id == selectedCategory}"></option>
                        </select>
                        <select class="form-control ml-2" name="price" id="filterPrice">
                            <option value="">All Prices</option>
                            <option value="free">Free</option>
                            <option value="paid" th:selected="${selectedPrice == 'paid'}">Paid</option>
                            <option value="low" th:selected="${selectedPrice == 'low'}">Below $50</option>
                            <option value="mid" th:selected="${selectedPrice == 'mid'}">50 - 100$</option>
                            <option value="high" th:selected="${selectedPrice == 'high'}">Above $100</option>
                        </select>
                    </div>

                </form>
            </div>

            <!-- Status Tabs -->
            <div class="custom-tabs mt-4">
                <ul class="nav nav-tabs" id="courseTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="pending-tab" data-bs-toggle="tab"
                                data-bs-target="#pending" type="button" role="tab" data-status="pending">
                            Pending<span class="badge bg-light text-dark ms-2" id="pendingCount">0</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="approved-tab" data-bs-toggle="tab"
                                data-bs-target="#approved" type="button" role="tab" data-status="approved">
                            Approved<span class="badge bg-light text-dark ms-2" id="approveCount">0</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="rejected-tab" data-bs-toggle="tab"
                                data-bs-target="#rejected" type="button" role="tab" data-status="rejected">
                            Rejected<span class="badge bg-light text-dark ms-2" id="rejectCount">0</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="resubmit-tab" data-bs-toggle="tab"
                                data-bs-target="#resubmit" type="button" role="tab" data-status="resubmit">
                            Resubmit<span class="badge bg-light text-dark ms-2" id="resubmitCount">0</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link " id="draft-tab" data-bs-toggle="tab"
                                data-bs-target="#draft" type="button" role="tab" data-status="draft">
                            Draft<span class="badge bg-light text-dark ms-2" id="draftCount">0</span>
                        </button>
                    </li>
                </ul>

                <div class="tab-content p-0" id="courseTabsContent">

                    <!-- Draft Tab -->
                    <div class="tab-pane fade" id="draft" role="tabpanel">
                    <div class="table-responsive">
                            <table class="table course-table">
                                <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Duration</th>
                                    <th>Price</th>
                                    <th>Total Lessons</th>
                                    <th>Created At</th>
                                    <th>Updated At</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                                </thead>
                                <tbody id="draftTableBody">
                                <!-- Data will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Pending Tab -->
                    <div class="tab-pane fade show active" id="pending" role="tabpanel">
                    <div class="table-responsive">
                            <table class="table course-table">
                                <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Duration</th>
                                    <th>Price</th>
                                    <th>Total Lessons</th>
                                    <th>Created At</th>
                                    <th>Updated At</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                                </thead>
                                <tbody id="pendingTableBody">
                                <!-- Data will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Approved Tab -->
                    <div class="tab-pane fade" id="approved" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table course-table">
                                <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Duration</th>
                                    <th>Price</th>
                                    <th>Total Lessons</th>
                                    <th>Created At</th>
                                    <th>Updated At</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                                </thead>
                                <tbody id="approvedTableBody">
                                <!-- Data will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Rejected Tab -->
                    <div class="tab-pane fade" id="rejected" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table course-table">
                                <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Duration</th>
                                    <th>Price</th>
                                    <th>Total Lessons</th>
                                    <th>Created At</th>
                                    <th>Updated At</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                                </thead>
                                <tbody id="rejectedTableBody">
                                <!-- Data will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Resubmit Tab -->
                    <div class="tab-pane fade" id="resubmit" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table course-table">
                                <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Duration</th>
                                    <th>Price</th>
                                    <th>Total Lessons</th>
                                    <th>Created At</th>
                                    <th>Updated At</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                                </thead>
                                <tbody id="resubmitTableBody">
                                <!-- Data will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>

            <div class="clearfix">
                <div class="hint-text">Showing <b>5</b> out of <b>25</b> entries</div>
                <ul class="pagination">
                    <li class="page-item disabled"><a href="#"><i class="fa fa-angle-double-left"></i></a></li>
                    <li class="page-item"><a href="#" class="page-link">1</a></li>
                    <li class="page-item"><a href="#" class="page-link">2</a></li>
                    <li class="page-item active"><a href="#" class="page-link">3</a></li>
                    <li class="page-item"><a href="#" class="page-link">4</a></li>
                    <li class="page-item"><a href="#" class="page-link">5</a></li>
                    <li class="page-item"><a href="#" class="page-link"><i class="fa fa-angle-double-right"></i></a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentStatus = 'pending';

        function getTableBodyElement(status) {
            switch (status) {
                case 'null':
                    return $('#draftTableBody');
                case 'pending':
                    return $('#pendingTableBody');
                case 'approved':
                    return $('#approvedTableBody');
                case 'rejected':
                    return $('#rejectedTableBody');
                case 'resubmit':
                    return $('#resubmitTableBody');
                default:
                    return $('#pendingTableBody');
            }
        }

        function filterCourses(status) {
            let keyword = $('#searchInput').val().trim(); // Sử dụng ID chính xác
            let category = $('#filterCategory').val();
            let price = $('#filterPrice').val();

            let statusParam = (status === 'draft') ? null : status;

            console.log("Filtering with keyword:", keyword, "category:", category, "price:", price, "status:", status);

            let tableBody = getTableBodyElement(status);
            if (!tableBody) {
                console.error("Table body not found for status:", status);
                return;
            }

            // Hiển thị loading indicator
            tableBody.html('<tr><td colspan="9" class="text-center"><i class="fas fa-spinner fa-spin"></i> Đang tải...</td></tr>');

            $.ajax({
                url: '/admin/course/filter',
                method: 'GET',
                data: {
                    keyword: keyword || null,
                    category: category || null,
                    price: price || null,
                    status: status
                },
                success: function (data) {
                    tableBody.html(data);
                    console.log("Course filter successful for status:", status);
                    updateStatusCountBadge(status, data);
                },
                error: function (xhr, status, error) {
                    console.error("AJAX Error:", status, error);
                    console.error("Response:", xhr.responseText);
                    tableBody.html('<tr><td colspan="9" class="text-center text-danger">Đã xảy ra lỗi khi tải dữ liệu: ' + error + '</td></tr>');
                }
            });
        }

        function updateStatusCountBadge(status, data) {
            const statusMap = {
                'pending': 'pendingCount',
                'approved': 'approveCount',
                'rejected': 'rejectCount',
                'resubmit': 'resubmitCount',
                'null': 'draftCount'
            };

            const badgeId = statusMap[status];
            const badgeElement = document.getElementById(badgeId);

            if (!badgeElement) return;

            const tempDiv = document.createElement('tbody');
            tempDiv.innerHTML = data;

            const rows = tempDiv.querySelectorAll('tr');

            const rowCount = Array.from(rows).filter(row =>
                !row.textContent.includes("Không tìm thấy")
            ).length;

            badgeElement.textContent = rowCount;
        }


        function loadCourses(status) {
            console.log("Loading courses for status:", status);
            filterCourses(status);
        }

        $(document).ready(function () {
            // Load initial data for all tabs
            [ 'pending','null', 'approved', 'rejected', 'resubmit'].forEach(status => {
                loadCourses(status);
            });

            // Tab change event - sử dụng selector chính xác hơn
            $('button[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
                const status = $(this).data('status');
                currentStatus = status;
                filterCourses(currentStatus);
            });

            // Filter events
            $('#filterCategory').on('change', function () {
                filterCourses(currentStatus);
            });

            $('#filterPrice').on('change', function () {
                filterCourses(currentStatus);
            });

            // Search input với debounce - sử dụng ID chính xác
            let searchTimer;
            $('#searchInput').on('input', function () {
                const searchValue = $(this).val();
                console.log("Search input triggered - value:", searchValue);
                clearTimeout(searchTimer);
                searchTimer = setTimeout(function () {
                    filterCourses(currentStatus);
                }, 500);
            });

            // Thêm event handler cho form submit để prevent default behavior
            $('#filterForm').on('submit', function (e) {
                e.preventDefault();
                console.log("Form submit prevented, triggering filter instead");
                filterCourses(currentStatus);
            });

        });

    </script>

</div>
