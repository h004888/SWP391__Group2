<div th:fragment="reportDetailContent">
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h5 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-flag me-2"></i>Chi tiết báo cáo
            </h5>
            <a th:href="@{/admin/course/detail/{courseId}(courseId=${report.course.courseId})}"
                class="btn btn-success btn-sm">
                <i class="fas fa-book-open me-1"></i>Xem chi tiết khóa học
            </a>
        </div>
        <div class="card-body">
            <dl class="row">
                <dt class="col-sm-3">Loại báo cáo</dt>
                <dd class="col-sm-9">
                    <span
                        th:text="${report.reportType == 'REPORT_COURSE' ? 'Báo cáo khóa học' : 'Báo cáo bình luận'}"></span>
                </dd>

                <dt class="col-sm-3">Người báo cáo</dt>
                <dd class="col-sm-9">
                    <span th:text="${report.user.fullName}"></span>
                    (<span th:text="${report.user.email}"></span>)
                </dd>

                <dt class="col-sm-3">Thời gian tạo</dt>
                <dd class="col-sm-9">
                    <span th:text="${#temporals.format(report.createdAt, 'dd/MM/yyyy HH:mm')}"></span>
                </dd>

                <dt class="col-sm-3">Nội dung báo cáo</dt>
                <dd class="col-sm-9">
                    <span th:text="${report.content}"></span>
                </dd>

                <dt class="col-sm-3">Link/chứng cứ</dt>
                <dd class="col-sm-9">
                    <th:block th:if="${evidenceLink != null}">
                        <th:block
                            th:if="${#strings.contains(evidenceLink, 'image') || evidenceLink.matches('.*\\.(jpg|jpeg|png|gif)$')}">
                            <img th:src="${evidenceLink}" alt="Bằng chứng ảnh"
                                style="max-width: 300px; max-height: 200px; display: block; margin-top: 8px;" />
                        </th:block>
                        <th:block
                            th:if="${#strings.contains(evidenceLink, 'video') || evidenceLink.matches('.*\\.(mp4|webm|ogg)$')}">
                            <video th:src="${evidenceLink}" controls
                                style="max-width: 300px; max-height: 200px; display: block; margin-top: 8px;"></video>
                        </th:block>
                        <a th:if="${!(#strings.contains(evidenceLink, 'image') || evidenceLink.matches('.*\\.(jpg|jpeg|png|gif)$') || #strings.contains(evidenceLink, 'video') || evidenceLink.matches('.*\\.(mp4|webm|ogg)$'))}"
                            th:href="${evidenceLink}" target="_blank" th:text="${evidenceLink}"></a>
                    </th:block>
                    <span th:if="${evidenceLink == null}">Không có</span>
                </dd>

                <dt class="col-sm-3">Trạng thái</dt>
                <dd class="col-sm-9">
                    <span th:text="${report.status}"></span>
                </dd>

                <!-- Hiển thị phản hồi của instructor nếu có -->
                <th:block th:if="${instructorReplyNotification != null}">
                    <dt class="col-sm-3">Phản hồi từ Instructor</dt>
                    <dd class="col-sm-9">
                        <div class="border rounded p-2 mb-2 bg-light" th:text="${instructorReplyNotification.message}">
                        </div>
                        <span class="badge bg-secondary me-2"
                            th:text="'Instructor: ' + ${instructorReplyNotification.user.fullName}"></span>
                        <span class="badge bg-info"
                            th:text="${#temporals.format(instructorReplyNotification.sentAt, 'dd/MM/yyyy HH:mm')}"></span>
                        <div th:if="${instructorReplyNotification.evidenceLink != null}" class="mt-2">
                            <span class="fw-bold">Bằng chứng:</span>
                            <th:block
                                th:if="${#strings.contains(instructorReplyNotification.evidenceLink, 'image') || instructorReplyNotification.evidenceLink.matches('.*\\.(jpg|jpeg|png|gif)$')}">
                                <img th:src="${instructorReplyNotification.evidenceLink}" alt="Bằng chứng ảnh"
                                    style="max-width: 300px; max-height: 200px; display: block; margin-top: 8px;" />
                            </th:block>
                            <th:block
                                th:if="${#strings.contains(instructorReplyNotification.evidenceLink, 'video') || instructorReplyNotification.evidenceLink.matches('.*\\.(mp4|webm|ogg)$')}">
                                <video th:src="${instructorReplyNotification.evidenceLink}" controls
                                    style="max-width: 300px; max-height: 200px; display: block; margin-top: 8px;"></video>
                            </th:block>
                            <a th:href="${instructorReplyNotification.evidenceLink}" target="_blank"
                                class="d-block mt-1">Xem file</a>
                        </div>
                    </dd>
                </th:block>
                <!-- Hiển thị nội dung comment bị report nếu là report comment -->
                <th:block th:if="${report.reportType == 'COMMENT' and reportedComment != null}">
                    <dt class="col-sm-3">Nội dung bình luận bị báo cáo</dt>
                    <dd class="col-sm-9">
                        <div class="border rounded p-2 mb-2" th:text="${reportedComment.comment}"></div>
                        <span class="badge bg-secondary me-2"
                            th:text="'Tác giả: ' + ${reportedComment.enrollment.user.fullName}"></span>
                        <span class="badge bg-info"
                            th:text="${#temporals.format(reportedComment.createdAt, 'dd/MM/yyyy HH:mm')}"></span>
                        <div class="mt-2">
                            <button type="button" class="btn btn-warning btn-sm" th:if="${!reportedComment.hidden}"
                                th:onclick="|hideComment(${reportedComment.reviewId}, true)|">Ẩn bình luận</button>
                            <button type="button" class="btn btn-success btn-sm" th:if="${reportedComment.hidden}"
                                th:onclick="|hideComment(${reportedComment.reviewId}, false)|">Hiện bình luận</button>
                            <span th:if="${reportedComment.hidden}" class="badge bg-danger ms-2">Đã bị ẩn</span>
                        </div>
                    </dd>
                </th:block>
                <th:block th:if="${report.reportType == 'COMMENT' and reportedComment == null}">
                    <dt class="col-sm-3">Nội dung bình luận bị báo cáo</dt>
                    <dd class="col-sm-9 text-danger">Bình luận đã bị xóa hoặc không tồn tại.</dd>
                </th:block>
            </dl>
            <form th:if="${report.status != 'processed'}" th:action="@{/admin/reports/process/{id}(id=${report.id})}"
                method="post">
                <button type="submit" class="btn btn-success">Processed</button>
            </form>
        </div>
        <script>
            function hideComment(reviewId, hidden) {
                if (hidden && !confirm('Bạn có chắc muốn ẩn bình luận này?')) return;
                if (!hidden && !confirm('Bạn có chắc muốn hiện lại bình luận này?')) return;
                fetch('/admin/reports/hide-comment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reviewId: reviewId, hidden: hidden })
                })
                    .then(res => res.text())
                    .then(data => {
                        if (data === 'success') {
                            // Nếu trang lesson đang mở ở window.opener, reload comment động
                            if (window.opener && typeof window.opener.loadComments === 'function') {
                                window.opener.loadComments(
                                    window.opener.document.querySelector('input[name="courseId"]').value,
                                    window.opener.document.querySelector('input[name="lessonId"]').value
                                );
                            }
                            location.reload();
                        } else {
                            alert('Có lỗi xảy ra!');
                        }
                    });
            }
        </script>
    </div>
</div>