<div id="content" class="container-fluid" th:fragment="contentOrders">
  <div class="table-responsive">
    <div class="table-wrapper">
      <div class="table-title">
        <form id="filterForm" method="get">
          <input type="hidden" id="currentPage" th:value="${currentPage}"/>
          <input type="hidden" id="pageSize" th:value="${pageSize}"/>
          <div class="row">
            <div class="col-md-8">
              <h2 th:text="${accNamePage}">Management <b>Order</b></h2>
            </div>
            <div class="col-md-4">
              <div class="search-box mt-2">
                <i class="material-icons"></i>
                <input type="text" class="form-control" name="username" id="filterUsername" th:value="${username}" placeholder="Search by username…" />
              </div>
            </div>
          </div>
          <div class="col-md-6 d-flex gap-2 mt-4">
            <select class="form-control" name="amountDirection" id="filterAmount">
              <option value="" th:selected="${amountDirection == null or amountDirection == ''}">All Amounts</option>
              <option value="asc" th:selected="${amountDirection == 'asc'}">Low to High</option>
              <option value="desc" th:selected="${amountDirection == 'desc'}">High to Low</option>
            </select>
            <select class="form-control" name="dateDirection" id="filterDate">
              <option value="" th:selected="${dateDirection == null or dateDirection == ''}">All Dates</option>
              <option value="asc" th:selected="${dateDirection == 'asc'}">Oldest First</option>
              <option value="desc" th:selected="${dateDirection == 'desc'}">Newest First</option>
            </select>
          </div>
        </form>
      </div>

      <div th:fragment="ordersTableBody" id="ordersTableBody" class="table-responsive">
        <table class="table table-striped table-hover table-bordered">
          <thead>
          <tr>
            <th>Order ID</th>
            <th>Amount</th>
            <th>Order Type</th>
            <th>Status</th>
            <th>Order Date</th>
            <th>Note</th>
            <th>Username</th>
            <th>Role</th>
            <th>Action</th>
          </tr>
          </thead>
          <tbody>
          <tr th:each="order : ${orders}">
            <td th:text="${order.orderId} ?: 'N/A'"></td>
            <td th:text="${order.amount} ?: 'N/A'"></td>
            <td th:text="${order.orderType} ?: 'N/A'"></td>
            <td th:text="${order.status} ?: 'N/A'"></td>
            <td th:with="formatter=${#temporals.format(order.orderDate, 'dd/MM/yyyy HH:mm')}" th:text="${formatter}"></td>
            <td th:text="${order.note} ?: 'N/A'"></td>
            <td th:text="${order.username} ?: 'N/A'"></td>
            <td th:text="${order.role} ?: 'N/A'"></td>
            <td>
              <a th:href="@{/admin/orders/view/{orderId}(orderId=${order.orderId})}"
                 class="btn btn-info btn-sm" title="View Detail"><i class="fas fa-eye"></i></a>
            </td>
          </tr>
          </tbody>
        </table>
        <div class="clearfix">
          <div class="hint-text">Showing <b th:text="${orders.size()}"></b> out of <b th:text="${totalItems}"></b> entries</div>
          <ul class="pagination">
            <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
              <a th:href="@{/admin/orders(page=${currentPage - 1}, size=${pageSize}, username=${username}, amountDirection=${amountDirection}, dateDirection=${dateDirection})}"
                 th:if="${currentPage > 0}"><i class="fa fa-angle-double-left"></i></a>
            </li>
            <li th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                class="page-item" th:classappend="${currentPage == i} ? 'active'">
              <a th:href="@{/admin/orders(page=${i}, size=${pageSize}, username=${username}, amountDirection=${amountDirection}, dateDirection=${dateDirection})}"
                 th:text="${i + 1}" class="page-link"></a>
            </li>
            <li class="page-item" th:classappend="${currentPage == totalPages - 1} ? 'disabled'">
              <a th:href="@{/admin/orders(page=${currentPage + 1}, size=${pageSize}, username=${username}, amountDirection=${amountDirection}, dateDirection=${dateDirection})}"
                 th:if="${currentPage < totalPages - 1}"><i class="fa fa-angle-double-right"></i></a>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    function filterOrders(page = 0, size = 5) {
      let username = $('#filterUsername').val().trim();
      let amountDirection = $('#filterAmount').val();
      let dateDirection = $('#filterDate').val();

      console.log("Filtering with username:", username, "amountDirection:", amountDirection, "dateDirection:", dateDirection, "page:", page, "size:", size);

      // Tạo URL mới
      let url = new URL(window.location.origin + '/admin/orders');
      url.searchParams.set('page', page);
      url.searchParams.set('size', size);
      if (username) url.searchParams.set('username', username);
      if (amountDirection) url.searchParams.set('amountDirection', amountDirection);
      if (dateDirection) url.searchParams.set('dateDirection', dateDirection);

      // Gửi yêu cầu AJAX
      $.ajax({
        url: '/admin/orders/filter',
        method: 'GET',
        data: {
          username: username || null,
          amountDirection: amountDirection || null,
          dateDirection: dateDirection || null,
          page: page,
          size: size
        },
        success: function (data) {
          $('#ordersTableBody').html(data);
          // Cập nhật URL mà không tải lại trang
          window.history.pushState({}, '', url);
          // Cập nhật input ẩn currentPage
          $('#currentPage').val(page);
          console.log("Orders filter successful, URL updated to:", url.toString());
        },
        error: function (xhr, status, error) {
          console.error("AJAX Error:", status, error);
          alert("An error occurred while loading data: " + error);
        }
      });
    }

    $(document).ready(function () {
      // Trigger filter on select change
      $('#filterAmount, #filterDate').on('change', function () {
        console.log("Filter changed:", $(this).attr('id'), $(this).val());
        filterOrders(0, $('#pageSize').val()); // Reset về trang 0 khi thay đổi bộ lọc
      });

      // Debounce username input
      let timer;
      $('#filterUsername').on('input', function () {
        console.log("Username input:", $(this).val());
        clearTimeout(timer);
        timer = setTimeout(() => filterOrders(0, $('#pageSize').val()), 300);
      });

      // Handle pagination clicks
      $(document).on('click', '.page-link', function (e) {
        e.preventDefault();
        let page = $(this).text() - 1; // Page number from link
        if ($(this).find('i.fa-angle-double-left').length) {
          page = parseInt($('#currentPage').val()) - 1;
        } else if ($(this).find('i.fa-angle-double-right').length) {
          page = parseInt($('#currentPage').val()) + 1;
        }
        if (page >= 0) {
          filterOrders(page, $('#pageSize').val());
        }
      });

      // Trigger initial filter if parameters exist
      let initialUsername = $('#filterUsername').val();
      let initialAmount = $('#filterAmount').val();
      let initialDate = $('#filterDate').val();
      let initialPage = $('#currentPage').val() || 0;
      let initialSize = $('#pageSize').val() || 5;
      if (initialUsername || initialAmount || initialDate || initialPage) {
        filterOrders(initialPage, initialSize);
      }
    });
  </script>
</div>